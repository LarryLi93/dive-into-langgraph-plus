# Z-Image 部署指南

## 概述

本指南详细说明如何在 Linux 环境下部署 Z-Image 图像生成模型。Z-Image 是基于 Diffusion 模型的高质量图像生成系统，需要 CUDA 支持的 GPU 环境。

## 系统要求

- Linux 操作系统（Ubuntu/CentOS 等）
- NVIDIA GPU（支持 CUDA 12.1+）
- Python 3.10
- Conda 或 Miniconda
- 至少 10GB 可用磁盘空间

## 前置条件检查

```bash
# 检查 CUDA 版本
nvidia-smi
nvcc --version

# 检查 Python 版本
python --version

# 检查 Conda
conda --version
```

## 部署步骤

### 1. 创建工作目录

```bash
### 2. 创建 Python 环境

```bash
# 创建名为 zimage 的 conda 环境，使用 Python 3.10
conda create -n zimage python=3.10

# 激活 conda 环境
conda activate zimage
```

### 3. 安装 Diffusers（从源码安装）

```bash
# 克隆 Hugging Face Diffusers 仓库
git clone https://github.com/huggingface/diffusers.git

# 进入项目目录
cd diffusers

# 以开发模式安装（可编辑模式）
pip install -e .
```

> **注意**：必须从源码安装，详细信息请参考 [官方仓库](https://github.com/Tongyi-MAI/Z-Image)

### 4. 安装 PyTorch（GPU 版本）

```bash
# 检查当前 CUDA 版本
nvcc --version

# 根据 CUDA 版本选择对应的 PyTorch 版本
# 访问 https://pytorch.org/get-started/locally/ 获取正确的安装命令
# 示例：CUDA 12.1 版本
pip3 install torch torchvision --index-url https://download.pytorch.org/whl/cu121
```

### 5. 安装 Transformers

```bash
# 安装 Hugging Face Transformers 库
pip install transformers
```

### 6. 下载模型

由于 Hugging Face 模型下载需要科学上网，我们使用 ModelScope 作为替代方案：

```bash
# 安装 ModelScope 库
pip install modelscope

# 下载 Z-Image-Turbo 模型
modelscope download --model Tongyi-MAI/Z-Image-Turbo
```

> **模型位置**：下载的模型将保存在 `/root/.cache/modelscope/hub/models/Tongyi-MAI/Z-Image-Turbo`

## 验证安装

### 1. 验证 Python 环境

```bash
# 激活环境
conda activate zimage

# 检查 Python 版本
python --version

# 检查已安装的包
pip list | grep -E "(torch|transformers|diffusers|modelscope)"
```

### 2. 验证 PyTorch 和 CUDA

```bash
# 启动 Python 解释器
python

# 在 Python 中执行以下代码
import torch
print(f"PyTorch 版本: {torch.__version__}")
print(f"CUDA 是否可用: {torch.cuda.is_available()}")
if torch.cuda.is_available():
    print(f"CUDA 版本: {torch.version.cuda}")
    print(f"GPU 数量: {torch.cuda.device_count()}")
    print(f"GPU 名称: {torch.cuda.get_device_name(0)}")

# 退出 Python
exit()
```

### 3. 验证模型文件

```bash
# 检查模型文件是否存在
ls -la /root/.cache/modelscope/hub/models/Tongyi-MAI/Z-Image-Turbo/
```

## 使用示例

创建一个简单的测试脚本来验证 Z-Image 的功能：

```bash
# 创建测试脚本
cat > test_zimage.py << 'EOF'
import torch
from diffusers import DiffusionPipeline
from modelscope.hub.snapshot_download import snapshot_download

# 设置设备
device = "cuda" if torch.cuda.is_available() else "cpu"
print(f"使用设备: {device}")

# 加载模型（需要先下载模型）
try:
    # 加载本地模型
    model_path = "/root/.cache/modelscope/hub/models/Tongyi-MAI/Z-Image-Turbo"
    pipe = DiffusionPipeline.from_pretrained(model_path, torch_dtype=torch.float16)
    pipe = pipe.to(device)
    
    # 生成测试图像
    prompt = "A beautiful sunset over mountains"
    print(f"正在生成图像，提示词: {prompt}")
    
    with torch.autocast(device):
        image = pipe(prompt, num_inference_steps=20).images[0]
    
    # 保存图像
    image.save("test_output.png")
    print("图像生成成功！保存为 test_output.png")
    
except Exception as e:
    print(f"错误: {e}")
    print("请确保已正确安装所有依赖并下载了模型")
EOF

# 运行测试脚本
python test_zimage.py
```

## 常见问题解决

### 问题 1：CUDA 内存不足

**症状**：`RuntimeError: CUDA out of memory`

**解决方案**：
```bash
# 减少批处理大小或图像分辨率
# 或者清理 GPU 缓存
python -c "import torch; torch.cuda.empty_cache()"
```

### 问题 2：模型下载失败

**症状**：网络连接错误或下载超时

**解决方案**：
```bash
# 重新尝试下载
modelscope download --model Tongyi-MAI/Z-Image-Turbo --local_dir ./zimage_model

# 或使用代理（如果有）
export HTTP_PROXY=http://your-proxy:port
export HTTPS_PROXY=http://your-proxy:port
```

### 问题 3：依赖版本冲突

**症状**：`ImportError` 或 `ModuleNotFoundError`

**解决方案**：
```bash
# 卸载冲突的包并重新安装
pip uninstall torch torchvision transformers diffusers
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121
pip install transformers
pip install -e .
```

### 问题 4：权限问题

**症状**：`Permission denied` 错误

**解决方案**：
```bash
# 给用户添加权限（需要 sudo）
sudo chown -R $USER:$USER /root/.cache/modelscope/
```

## 性能优化建议

1. **GPU 内存优化**：
   - 使用半精度（float16）计算
   - 减少批处理大小
   - 启用梯度检查点（如果需要）

2. **推理加速**：
   - 使用 torch.compile() 优化模型
   - 启用 XFormers（如果可用）
   - 使用优化的注意力机制

3. **存储优化**：
   - 定期清理 PyTorch 缓存
   - 使用模型量化（如果质量要求允许）

## 卸载（如需要）

```bash
# 停用环境
conda deactivate

# 删除环境
conda env remove -n zimage

# 清理模型缓存（可选）
rm -rf /root/.cache/modelscope/hub/models/Tongyi-MAI/Z-Image-Turbo/
```

