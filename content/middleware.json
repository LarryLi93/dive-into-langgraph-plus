{"version":3,"kind":"Notebook","sha256":"d7b6b8597e98c53716193f1b2b6b3ee90bb881d8790ceb36b87f95b0085b25e8","slug":"middleware","location":"/3.middleware.ipynb","dependencies":[],"frontmatter":{"title":"ä¸­é—´ä»¶","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"base","language":"python"},"authors":[{"nameParsed":{"literal":"Larry Li","given":"Larry","family":"Li"},"name":"Larry Li","id":"contributors-Users\\Lenovo\\Desktop\\product\\dive-into-langgraph-plus\\myst-generated-uid-0"}],"github":"https://github.com/LarryLi93/dive-into-langgraph-plus","exports":[{"format":"ipynb","filename":"3.middleware.ipynb","url":"/3.middleware-44c782fcb4e01808269d5c3d430bbe6e.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langchain/middleware/overview","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"ä¸­é—´ä»¶","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GCJ0mshltj"}],"urlSource":"https://docs.langchain.com/oss/python/langchain/middleware/overview","key":"pxFk0lAtfx"},{"type":"text","value":"ï¼ˆmiddlewareï¼‰æ˜¯æœ¬æ¬¡æ›´æ–°ä¸­æœ€äº®çœ¼çš„ç‰¹æ€§ï¼Œè¯¸å¤šæ–°åŠŸèƒ½å‡è—‰ç”±ä¸­é—´ä»¶å®ç°ï¼Œæ¯”å¦‚äººæœºäº¤äº’ã€åŠ¨æ€ç³»ç»Ÿæç¤ºè¯ã€åŠ¨æ€æ³¨å…¥ä¸Šä¸‹æ–‡ç­‰ç­‰ã€‚å¯ä»¥å°†ä¸­é—´ä»¶è§†ä¸ºä¸€ç§é’©å­å‡½æ•°ã€‚é€šè¿‡å‘å·¥ä½œæµé¢„åŸ‹ä¸­é—´ä»¶ï¼Œèƒ½å¤Ÿå®ç°å·¥ä½œæµçš„é«˜æ•ˆæ‹“å±•å’Œå¯å®šåˆ¶åŒ–ã€‚","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"fJHr0FKQRA"}],"key":"Hkpj7ISNys"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"LangChain å¯é€šè¿‡ ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"IEKIOifm2n"},{"type":"link","url":"https://reference.langchain.com/python/langchain/middleware/#decorators","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"è£…é¥°å™¨","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"joyDWFaLjA"}],"urlSource":"https://reference.langchain.com/python/langchain/middleware/#decorators","key":"OswWRJU2wU"},{"type":"text","value":" åˆ›å»º ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"nhsZS1TUgG"},{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"è‡ªå®šä¹‰ä¸­é—´ä»¶","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"TZV4BEaFSq"}],"key":"DzyY0o5ExK"},{"type":"text","value":"ã€‚","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"mvx51TlhCl"}],"key":"ChpFxXO97g"},{"type":"details","children":[{"type":"summary","children":[{"type":"text","value":"è£…é¥°å™¨åˆ—è¡¨ï¼ˆç‚¹å‡»å±•å¼€ï¼‰","key":"Wu6wtQNMYi"}],"key":"lNfzSb3myE"},{"type":"table","children":[{"type":"tableRow","children":[{"type":"tableCell","header":true,"children":[{"type":"text","value":"DECORATOR","key":"loVgh0HwIE"}],"key":"bYHXX8K2l6"},{"type":"tableCell","header":true,"children":[{"type":"text","value":"DESCRIPTION","key":"vQvfxntFtE"}],"key":"j9uDocNkG5"}],"key":"tktwKK5w2F"},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"inlineCode","value":"@before_agent","key":"irj84HeE2d"}],"key":"aixDiBzHPu"},{"type":"tableCell","children":[{"type":"text","value":"åœ¨ Agent æ‰§è¡Œå‰æ‰§è¡Œé€»è¾‘","key":"b2dDKb3Krz"}],"key":"aNLrxfDbpn"}],"key":"JaI2uyK5IM"},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"inlineCode","value":"@after_agent","key":"Ry5geIxLeb"}],"key":"MDq6zYtMzE"},{"type":"tableCell","children":[{"type":"text","value":"åœ¨ Agent æ‰§è¡Œåæ‰§è¡Œé€»è¾‘","key":"TVDRtunlCP"}],"key":"zZMy6Lbmx1"}],"key":"WdgPzdGCP0"},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"inlineCode","value":"@before_model","key":"Y4mc47RwcX"}],"key":"X01HboCeke"},{"type":"tableCell","children":[{"type":"text","value":"åœ¨æ¯æ¬¡æ¨¡å‹è°ƒç”¨å‰æ‰§è¡Œé€»è¾‘","key":"aWg2s4Q6KT"}],"key":"UB4POlSjO7"}],"key":"rGV36PYvDZ"},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"inlineCode","value":"@after_model","key":"uKELz0OaYW"}],"key":"y63j0SH4Cb"},{"type":"tableCell","children":[{"type":"text","value":"åœ¨æ¯æ¬¡æ¨¡å‹æ”¶åˆ°å“åº”åæ‰§è¡Œé€»è¾‘","key":"kxSSzRic0z"}],"key":"fAl7Sv3VFB"}],"key":"YACRxvyLnf"},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"inlineCode","value":"@wrap_model_call","key":"l61uxh2OZL"}],"key":"YVXB8ZRnII"},{"type":"tableCell","children":[{"type":"text","value":"æ§åˆ¶æ¨¡å‹çš„è°ƒç”¨è¿‡ç¨‹","key":"zwGCu6ojtD"}],"key":"kTWnfVmURO"}],"key":"cRtoliT2Ep"},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"inlineCode","value":"@wrap_tool_call","key":"VYXwtPV2Hs"}],"key":"PjvdqUhHC8"},{"type":"tableCell","children":[{"type":"text","value":"æ§åˆ¶å·¥å…·çš„è°ƒç”¨è¿‡ç¨‹","key":"A6cOAnCbKc"}],"key":"jSXfwd3wAk"}],"key":"HOuIlJsAjy"},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"inlineCode","value":"@dynamic_prompt","key":"KCB5jeBF7B"}],"key":"S4pHWrHG9v"},{"type":"tableCell","children":[{"type":"text","value":"åŠ¨æ€ç”Ÿæˆç³»ç»Ÿæç¤ºè¯","key":"h6LtNLkVg5"}],"key":"ZrgMZJYh6l"}],"key":"Hvv2igCnEK"},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"inlineCode","value":"@hook_config","key":"h1kTjDJdxo"}],"key":"evK1C6Argt"},{"type":"tableCell","children":[{"type":"text","value":"é…ç½®é’©å­è¡Œä¸º","key":"RmtcQ65cvM"}],"key":"sO64eK5iQ9"}],"key":"WV9jDAmgxt"}],"key":"VORttZk6js"}],"key":"z2YKCVXODS"},{"type":"paragraph","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"strong","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"text","value":"è£…é¥°å™¨ç±»å‹","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"QOTQkUJDBs"}],"key":"cw3IJ7Y4BW"},{"type":"text","value":" å†³å®šä¸­é—´ä»¶åœ¨å·¥ä½œæµä¸­çš„æ‰§è¡Œä½ç½®ã€‚æ¯”å¦‚ä½¿ç”¨ ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"GdNBc4B0aZ"},{"type":"inlineCode","value":"@before_model","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"OywXtdh4QC"},{"type":"text","value":" è£…é¥°å™¨ï¼Œèƒ½å¤Ÿåœ¨æ¨¡å‹è°ƒç”¨å‰æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ã€‚","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"y56WenXync"},{"type":"strong","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"text","value":"è¢«è£…é¥°å‡½æ•°","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"nCy40VC59O"}],"key":"AsxBnuijDw"},{"type":"text","value":" è´Ÿè´£è¿™æ®µè‡ªå®šä¹‰é€»è¾‘çš„å…·ä½“å®ç°ã€‚è¿™ä¹ˆè¯´å¯èƒ½æœ‰ç‚¹æŠ½è±¡ã€‚æ²¡å…³ç³»ï¼Œæœ¬èŠ‚æä¾›äº†å››ä¸ªä¾‹å­ï¼Œçœ‹å®Œä½ è‚¯å®šèƒ½å¤Ÿæ„Ÿæ‚Ÿåˆ°ä¸­é—´ä»¶çš„ä½¿ç”¨æ–¹æ³•ï¼š","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"ySCT4w7GxX"}],"key":"QatbRjlpVW"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":25,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"é¢„ç®—æ§åˆ¶","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"fc8nDbdes2"}],"key":"OkFrTH9o7F"}],"key":"qKk4jXRMnZ"},{"type":"listItem","spread":true,"position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"æ¶ˆæ¯æˆªæ–­","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"GokEpWFs6Q"}],"key":"XsS3ULcbKR"}],"key":"y2aMMk2XMG"},{"type":"listItem","spread":true,"position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"æ•æ„Ÿè¯è¿‡æ»¤","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"k5ndUrb8uR"}],"key":"sLflodhmtj"}],"key":"IRw5XAlbQW"},{"type":"listItem","spread":true,"position":{"start":{"line":28,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"PII æ£€æµ‹","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"M6Bb3woUFr"},{"type":"inlineCode","value":"ï¼ˆä¸ªäººéšç§ä¿¡æ¯æ£€æµ‹ï¼‰","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"WWKq4gCZdX"}],"key":"ODcd51SRj9"}],"key":"dXRHxpAepS"}],"key":"s1rnQZTx7C"},{"type":"heading","depth":2,"position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"children":[{"type":"text","value":"ä¸€ã€é¢„ç®—æ§åˆ¶","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"key":"ohZpaZg4rB"}],"identifier":"id","label":"ä¸€ã€é¢„ç®—æ§åˆ¶","html_id":"id","implicit":true,"key":"UK8W7vmDWu"},{"type":"paragraph","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"children":[{"type":"text","value":"éšç€å¯¹è¯è½®æ¬¡å¢åŠ ï¼Œæ¯æ¬¡è¯·æ±‚æºå¸¦çš„å¯¹è¯è®°å½•ä¹Ÿä¼šè¶Šæ¥è¶Šé•¿ï¼Œä»è€Œå¯¼è‡´è¯·æ±‚è´¹ç”¨ä¸Šå‡ã€‚ä¸ºäº†æ§åˆ¶é¢„ç®—ï¼Œå¯ä»¥è®¾å®šåœ¨å¯¹è¯è½®æ¬¡è¶…è¿‡æŸä¸ªé˜ˆå€¼åï¼Œåˆ‡æ¢åˆ°ä½è´¹ç‡æ¨¡å‹ã€‚è¿™ä¸ªåŠŸèƒ½å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ä¸­é—´ä»¶å®ç°ã€‚","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"M0yviaOsqh"}],"key":"Rsqse2ScIU"}],"key":"oJLmeddi9o"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nfrom dotenv import load_dotenv\nfrom langchain_openai import ChatOpenAI\nfrom langchain.agents import create_agent\nfrom langchain.agents.middleware import wrap_model_call, ModelRequest, ModelResponse\nfrom langchain_core.messages import HumanMessage\nfrom langgraph.graph import MessagesState\n\n# åŠ è½½æ¨¡å‹é…ç½®\n_ = load_dotenv()\n\n# ä½è´¹ç‡æ¨¡å‹\nbasic_model = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n)\n\n# é«˜è´¹ç‡æ¨¡å‹\nadvanced_model = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-max\",\n)","key":"eRLh5EGdGn"},{"type":"outputs","id":"5w5NRYueT1u2TBdSeqvTI","children":[],"key":"EJY23FUXPJ"}],"key":"doNUMxyB8V"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"ç”±äºæˆ‘ä»¬çš„ä¿®æ”¹æ¶‰åŠåˆ°æ¨¡å‹æ¨ç†æœ¬èº«ï¼Œ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"x6UrzNHhrx"},{"type":"inlineCode","value":"@before_model","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"igazktmURl"},{"type":"text","value":" å’Œ ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cfRd1pxrZK"},{"type":"inlineCode","value":"@after_model","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kQEVdLMnXi"},{"type":"text","value":" åœ¨è¿™é‡Œå·²ç»ä¸å¤Ÿç”¨äº†ã€‚æˆ‘ä»¬ä½¿ç”¨èƒ½å¹²æ¶‰æ¨¡å‹è°ƒç”¨çš„ ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VkZ1Vc5VJl"},{"type":"link","url":"https://reference.langchain.com/python/langchain/middleware/#langchain.agents.middleware.wrap_model_call","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"@wrap_model_call","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"d5JOSgBmcb"}],"urlSource":"https://reference.langchain.com/python/langchain/middleware/#langchain.agents.middleware.wrap_model_call","key":"fL0EzJpSnD"},{"type":"text","value":" è£…é¥°å™¨ã€‚å…·ä½“é€»è¾‘ç”±è¢«è£…é¥°å‡½æ•° ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TfpSoJAdM6"},{"type":"inlineCode","value":"dynamic_model_selection","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uRmFpr2oVA"},{"type":"text","value":" å®ç°ï¼šå½“å†å²å¯¹è¯è¶…è¿‡ 5 æ¡æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ä½è´¹ç‡æ¨¡å‹ã€‚","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QiqcGHAcuq"}],"key":"QhQatEy5QT"}],"key":"YsAXtBYWXz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@wrap_model_call\ndef dynamic_model_selection(request: ModelRequest, handler) -> ModelResponse:\n    \"\"\"Choose model based on conversation complexity.\"\"\"\n    message_count = len(request.state[\"messages\"])\n\n    if message_count > 5:\n        # Use a basic model for longer conversations\n        model = basic_model\n    else:\n        model = advanced_model\n\n    request.model = model\n    print(f\"message_count: {message_count}\")\n    print(f\"model_name: {model.model_name}\")\n\n    return handler(request)\n\nagent = create_agent(\n    model=advanced_model,  # Default model\n    middleware=[dynamic_model_selection]\n)","key":"XkIuGl9DFY"},{"type":"outputs","id":"TXSjUQOjQgBUWbdTbmEGN","children":[],"key":"FEqFE0tRJL"}],"key":"h3r8t6yamC"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"ä»ä¸‹é¢çš„ä¾‹å­å¯ä»¥çœ‹åˆ°ï¼Œå½“å†å²å¯¹è¯æ•° ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uBHDJwLiLY"},{"type":"inlineCode","value":"message_count","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Yz0yk4CLBL"},{"type":"text","value":" è¶…è¿‡ 5 æ¡æ—¶ï¼Œç¡®å®ä»é«˜è´¹ç‡æ¨¡å‹ ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VnYRNiZW7F"},{"type":"inlineCode","value":"qwen3-max","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zz2uWnHC0p"},{"type":"text","value":" åˆ‡æ¢åˆ°ä½è´¹ç‡æ¨¡å‹ ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GpBVpNNjIl"},{"type":"inlineCode","value":"qwen3-coder-plus","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LHNxYkIVxH"},{"type":"text","value":"ã€‚æˆ‘ä»¬æ­£ç¡®åœ°å®ç°äº†é¢„ç®—æ§åˆ¶åŠŸèƒ½ï¼","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"s1ggNCJODu"}],"key":"N4dTJX1KTK"}],"key":"oLZtGNIaj3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"state: MessagesState = {\"messages\": []}\nitems = ['æ±½è½¦', 'é£æœº', 'æ‘©æ‰˜è½¦', 'è‡ªè¡Œè½¦']\nfor idx, i in enumerate(items):\n    print(f\"\\n=== Round {idx+1} ===\")\n    state[\"messages\"] += [HumanMessage(content=f\"{i}æœ‰å‡ ä¸ªè½®å­ï¼Œè¯·ç®€å•å›ç­”\")]\n    result = agent.invoke(state)\n    state[\"messages\"] = result[\"messages\"]\n    print(f'content: {result[\"messages\"][-1].content}')","key":"jMG0bCkXY2"},{"type":"outputs","id":"X7QeDKcAPQpeG2AK39m8O","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"\n=== Round 1 ===\nmessage_count: 1\nmodel_name: qwen3-max\ncontent: æ™®é€šæ±½è½¦é€šå¸¸æœ‰4ä¸ªè½®å­ã€‚\n\n=== Round 2 ===\nmessage_count: 3\nmodel_name: qwen3-max\ncontent: é£æœºè½®å­æ•°é‡ä¸å›ºå®šï¼Œå¸¸è§çš„å®¢æœºä¸€èˆ¬æœ‰3ä¸ªèµ·è½æ¶ï¼ˆå‰1ä¸ªã€ä¸»èµ·è½æ¶2ä¸ªï¼‰ï¼Œæ€»å…±6åˆ°10ä¸ªè½®å­ã€‚\n\n=== Round 3 ===\nmessage_count: 5\nmodel_name: qwen3-max\ncontent: æ‘©æ‰˜è½¦é€šå¸¸æœ‰2ä¸ªè½®å­ã€‚\n\n=== Round 4 ===\nmessage_count: 7\nmodel_name: qwen3-coder-plus\ncontent: è‡ªè¡Œè½¦æœ‰2ä¸ªè½®å­ã€‚\n"},"children":[],"key":"yw79b4vXQ0"}],"key":"TukirknI4x"}],"key":"Jd7QA7gKDg"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"äºŒã€æ¶ˆæ¯æˆªæ–­","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"i2XT1WTETv"}],"identifier":"id","label":"äºŒã€æ¶ˆæ¯æˆªæ–­","html_id":"id-1","implicit":true,"key":"XlplIAkFU8"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"æ™ºèƒ½ä½“çš„ä¸Šä¸‹æ–‡å­˜åœ¨é•¿åº¦é™åˆ¶ã€‚ä¸€æ—¦è¶…è¿‡é™åˆ¶ï¼Œå°±éœ€è¦å¯¹ä¸Šä¸‹æ–‡è¿›è¡Œå‹ç¼©ã€‚åœ¨ä¼—å¤šæ–¹æ³•ä¸­ï¼Œæˆªæ–­æ˜¯æœ€ç®€å•ç²—æš´ã€æ˜“äºå®ç°çš„æ–¹æ³•ã€‚æ¶ˆæ¯æˆªæ–­åŠŸèƒ½å¯ä»¥é€šè¿‡ ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Ws78DsPsJp"},{"type":"inlineCode","value":"@before_model","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"VknngXvN1F"},{"type":"text","value":" è£…é¥°å™¨å®ç°ã€‚","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"N5QTw8cPyt"}],"key":"LjYvgdI2HD"}],"key":"Hze2gOgi8p"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from langchain.messages import RemoveMessage\nfrom langgraph.graph.message import REMOVE_ALL_MESSAGES\nfrom langgraph.checkpoint.memory import InMemorySaver\nfrom langchain.agents import create_agent, AgentState\nfrom langchain.agents.middleware import before_model\nfrom langgraph.runtime import Runtime\nfrom langchain_core.runnables import RunnableConfig\nfrom typing import Any","key":"Ht5sEJ4F4Y"},{"type":"outputs","id":"-1B8LSOE_PSicidBx0hVN","children":[],"key":"rd2xuVNyCw"}],"key":"poM39LI9p8"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"æˆ‘ä»¬å°è¯•ä¸€ç§æˆªæ–­ç­–ç•¥ï¼šåœ¨ä¿ç•™æœ€è¿‘æ¶ˆæ¯çš„åŒæ—¶ï¼Œé¢å¤–ä¿ç•™ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œç”±äºæˆ‘ä»¬åœ¨ç¬¬ä¸€æ¡æ¶ˆæ¯ä¸­å‘Šè¯‰æ™ºèƒ½ä½“ã€Œæˆ‘æ˜¯ bobã€ï¼Œå› æ­¤å®ƒè®°å¾—æˆ‘æ˜¯ bob.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Hv5GHxv5GC"}],"key":"bT5I89SOkd"}],"key":"R2vNXxnMCp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@before_model\ndef trim_messages(state: AgentState, runtime: Runtime) -> dict[str, Any] | None:\n    \"\"\"Keep only the last few messages to fit context window.\"\"\"\n    messages = state[\"messages\"]\n\n    if len(messages) <= 3:\n        return None  # No changes needed\n\n    first_msg = messages[0]\n    recent_messages = messages[-3:] if len(messages) % 2 == 0 else messages[-4:]\n    new_messages = [first_msg] + recent_messages\n\n    return {\n        \"messages\": [\n            RemoveMessage(id=REMOVE_ALL_MESSAGES),\n            *new_messages\n        ]\n    }\n\nagent = create_agent(\n    basic_model,\n    middleware=[trim_messages],\n    checkpointer=InMemorySaver(),\n)\n\nconfig: RunnableConfig = {\"configurable\": {\"thread_id\": \"1\"}}\n\ndef agent_invoke(agent):\n    agent.invoke({\"messages\": \"hi, my name is bob\"}, config)\n    agent.invoke({\"messages\": \"write a short poem about cats\"}, config)\n    agent.invoke({\"messages\": \"now do the same but for dogs\"}, config)\n    final_response = agent.invoke({\"messages\": \"what's my name?\"}, config)\n    \n    final_response[\"messages\"][-1].pretty_print()\n\nagent_invoke(agent)","key":"J3djnDHXE6"},{"type":"outputs","id":"znkW3yri8xUt5uBVPxd0Y","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"==================================\u001b[1m Ai Message \u001b[0m==================================\n\nYour name is Bob! You introduced yourself earlier.\n"},"children":[],"key":"sTjGovgVnl"}],"key":"ldElRhOXq5"}],"key":"gYfRiv4BE4"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"å½“ç„¶ï¼Œè¿™ä¸ªè¡¨ç°ä¸è¶³ä»¥è¯´æ˜æˆªæ–­ä¸­é—´ä»¶çœŸçš„ç”Ÿæ•ˆäº†ã€‚è‹¥è¿™ä¸ªä¸­é—´ä»¶ä»æœªç”Ÿæ•ˆï¼Œä¹Ÿä¼šæœ‰è¿™æ ·çš„ç»“æœã€‚ä¸ºäº†è¯æ˜å®ƒçœŸçš„ç”Ÿæ•ˆäº†ï¼Œæˆ‘ä»¬å†æ¬¡ä¿®æ”¹æˆªæ–­ç­–ç•¥ã€‚è¿™æ¬¡åªä¿ç•™æœ€åä¸¤æ¡å¯¹è¯è®°å½•ã€‚å¦‚æœæ™ºèƒ½ä½“ä¸è®°å¾—æˆ‘æ˜¯ bobï¼Œè¯´æ˜æˆªæ–­ä¸­é—´ä»¶ç¡®å®èµ·ä½œç”¨äº†ã€‚","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Cz3vqG3hcD"}],"key":"XviBnbacEA"}],"key":"AKnx7zLMyy"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@before_model\ndef trim_without_first_message(state: AgentState, runtime: Runtime) -> dict[str, Any] | None:\n    \"\"\"Keep only the last few messages to fit context window.\"\"\"\n    messages = state[\"messages\"]\n\n    return {\n        \"messages\": [\n            RemoveMessage(id=REMOVE_ALL_MESSAGES),\n            *messages[-2:]\n        ]\n    }\n\nagent = create_agent(\n    basic_model,\n    middleware=[trim_without_first_message],\n    checkpointer=InMemorySaver(),\n)\n\nagent_invoke(agent)","key":"qLpt2QNJDl"},{"type":"outputs","id":"AFTQKTdv1b640uB-hfCZd","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"==================================\u001b[1m Ai Message \u001b[0m==================================\n\nI don't actually know your name! You haven't shared that information with me yet. I'd be happy to learn what you'd like to be called - would you like to tell me your name?\n"},"children":[],"key":"J5ZNNMpHN1"}],"key":"aO0wpHwmql"}],"key":"b3jcJkR7iN"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"ç°åœ¨æ™ºèƒ½ä½“ä¸è®°å¾—æˆ‘æ˜¯è°ï¼Œè¯´æ˜ä¸­é—´ä»¶ç¡®å®ç”Ÿæ•ˆäº†ï¼","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HMsQdATONw"}],"key":"NxZp1Ryjjy"}],"key":"drkVW9LdZ4"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"ä¸‰ã€æ•æ„Ÿè¯è¿‡æ»¤","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uLY3hQXFHT"}],"identifier":"id","label":"ä¸‰ã€æ•æ„Ÿè¯è¿‡æ»¤","html_id":"id-2","implicit":true,"key":"y461zQhXCj"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"æŠ¤æ ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"bz3oD6BbDJ"}],"key":"wYRRi7Bl2R"},{"type":"text","value":"ï¼ˆGuardrailsï¼‰æ˜¯æ™ºèƒ½ä½“æä¾›çš„ä¸€ç±»å†…å®¹å®‰å…¨èƒ½åŠ›çš„ç»Ÿç§°ã€‚å¤§æ¨¡å‹æœ¬èº«å…·å¤‡ä¸€å®šçš„å†…å®¹é£æ§èƒ½åŠ›ï¼Œä½†å¾ˆå®¹æ˜“è¢«çªç ´ã€‚æœç´¢ã€Œå¤§æ¨¡å‹ç ´ç”²ã€å°±èƒ½æ‰¾åˆ°æ­¤ç±»æ•™ç¨‹ã€‚æ™ºèƒ½ä½“å¯ä»¥åœ¨æ¨¡å‹ä¹‹å¤–ï¼Œæä¾›é¢å¤–çš„å®‰å…¨ä¿æŠ¤ã€‚è¿™æ˜¯é€šè¿‡å·¥ç¨‹ä¸Šçš„å¼ºåˆ¶æ£€æŸ¥å®ç°çš„ã€‚","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"LgjJwiSKZN"}],"key":"IOcHZzVVYA"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"åœ¨ LangGraph ä¸­ï¼ŒæŠ¤æ å¯ä»¥é€šè¿‡ä¸­é—´ä»¶è½»æ¾å®ç°ã€‚ä¸‹é¢æˆ‘ä»¬å®ç°ä¸€ä¸ªç®€å•çš„æŠ¤æ ï¼šè‹¥ç”¨æˆ·çš„æœ€æ–°æ¶ˆæ¯ä¸­åŒ…å«æŸäº›æ•æ„Ÿè¯ï¼Œæ™ºèƒ½ä½“å°†æ‹’ç»å›ç­”ã€‚","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"x2qempHUPt"}],"key":"WYXAhPBPUp"}],"key":"QHzzbYuT9K"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from typing import Any\n\nfrom langchain.agents.middleware import before_agent, AgentState\nfrom langgraph.runtime import Runtime\n\nbanned_keywords = [\"hack\", \"exploit\", \"malware\"]\n\n@before_agent(can_jump_to=[\"end\"])\ndef content_filter(state: AgentState, runtime: Runtime) -> dict[str, Any] | None:\n    \"\"\"Deterministic guardrail: Block requests containing banned keywords.\"\"\"\n    # Get the first user message\n    if not state[\"messages\"]:\n        return None\n\n    last_message = state[\"messages\"][-1]\n    if last_message.type != \"human\":\n        return None\n\n    content = last_message.content.lower()\n\n    # Check for banned keywords\n    for keyword in banned_keywords:\n        if keyword in content:\n            # Block execution before any processing\n            return {\n                \"messages\": [{\n                    \"role\": \"assistant\",\n                    \"content\": \"I cannot process requests containing inappropriate content. Please rephrase your request.\"\n                }],\n                \"jump_to\": \"end\"\n            }\n\n    return None\n\nagent = create_agent(\n    model=basic_model,\n    middleware=[content_filter],\n)\n\n# This request will be blocked before any processing\nresult = agent.invoke({\n    \"messages\": [{\"role\": \"user\", \"content\": \"How do I hack into a database?\"}]\n})","key":"vCCHRo8Koo"},{"type":"outputs","id":"PTFjgZ65BQtlW4TPMrv7Z","children":[],"key":"Az6dr0RO1o"}],"key":"jgcVTKZma7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"for message in result[\"messages\"]:\n    message.pretty_print()","key":"yQL5Wl8QUG"},{"type":"outputs","id":"-zepyCGYa-6byQEsv7ucI","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nHow do I hack into a database?\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nI cannot process requests containing inappropriate content. Please rephrase your request.\n"},"children":[],"key":"Vf8u0QmMg2"}],"key":"TpQOTp8rJC"}],"key":"U9mGJszMFC"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"å››ã€PII æ£€æµ‹","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Vw2bB1Sv6t"}],"identifier":"id-pii","label":"å››ã€PII æ£€æµ‹","html_id":"id-pii","implicit":true,"key":"Ox0AJihhji"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­ç¼–å†™æŠ¤æ ã€‚","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ji6cZF7QN2"},{"type":"link","url":"https://docs.langchain.com/oss/python/langchain/guardrails#pii-detection","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"PII","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"g8M0qMAFBf"}],"urlSource":"https://docs.langchain.com/oss/python/langchain/guardrails#pii-detection","key":"EvK40VgLlj"},{"type":"text","value":"ï¼ˆPersonally Identifiable Informationï¼‰æ£€æµ‹å¯ä»¥å‘ç°ç”¨æˆ·è¾“å…¥ä¸­çš„é‚®ç®±ã€IPã€åœ°å€ã€é“¶è¡Œå¡ç­‰éšç§ä¿¡æ¯ï¼Œå¹¶åšå‡ºå¤„ç½®ã€‚","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"U2Z7gygi4T"}],"key":"d2pMf5gJBs"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"ä¸‹é¢çš„ä¾‹å­æ¥æºäºç”Ÿæ´»ã€‚æˆ‘ä»¬ç»å¸¸æŠŠæŠ¥é”™å¤åˆ¶ç»™å¤§æ¨¡å‹ï¼Œè®©å®ƒå¸®å¿™ debugã€‚ä½†æŠ¥é”™ä¸­å¯èƒ½åŒ…å«ä¸ªäººéšç§ä¿¡æ¯ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œé‡‡ç”¨ä»¥ä¸‹ä¸¤ç§æ–¹æ³•è¿›è¡Œå¤„ç½®ï¼š","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"or4FI30a22"}],"key":"knpDWIeKSf"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"æ‹’ç»å›ç­”é—®é¢˜","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"lqPGdIdPdR"}],"key":"cHXEyzp0xU"}],"key":"XarDA5Fll4"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"å±è”½éšç§ä¿¡æ¯","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"fGJm3EvXV1"}],"key":"rir5KFedTb"}],"key":"Ov6d3gerRD"}],"key":"LdL70xytGI"}],"key":"tmTToXu6gu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from textwrap import dedent\nfrom pydantic import BaseModel, Field\n\n# å¯ä¿¡ä»»çš„æ¨¡å‹ï¼Œä¸€èˆ¬æ˜¯æœ¬åœ°æ¨¡å‹ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œè¿™é‡Œä¾ç„¶ä½¿ç”¨qwen\ntrusted_model = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n)\n\n# ç”¨äºæ ¼å¼åŒ–æ™ºèƒ½ä½“è¾“å‡ºï¼Œè‹¥å‘ç°æ•æ„Ÿä¿¡æ¯è¿”å›Trueï¼Œæ²¡å‘ç°è¿”å›False\nclass PiiCheck(BaseModel):\n    \"\"\"Structured output indicating whether text contains PII.\"\"\"\n    is_pii: bool = Field(description=\"Whether the text contains PII\")\n\ndef message_with_pii(pii_middleware):\n    agent = create_agent(\n        model=basic_model,\n        middleware=[pii_middleware],\n    )\n\n    # This request will be blocked before any processing\n    result = agent.invoke({\n        \"messages\": [{\n            \"role\": \"user\",\n            \"content\": dedent(\n                \"\"\"\n                File \"/home/luochang/proj/agent.py\", line 53, in my_agent\n                    agent = create_react_agent(\n                            ^^^^^^^^^^^^^^^^^^^\n                File \"/home/luochang/miniconda3/lib/python3.12/site-packages/typing_extensions.py\", line 2950, in wrapper\n                    return arg(*args, **kwargs)\n                        ^^^^^^^^^^^^^^^^^^^^\n                File \"/home/luochang/miniconda3/lib/python3.12/site-packages/langgraph/prebuilt/chat_agent_executor.py\", line 566, in create_react_agent\n                    model = cast(BaseChatModel, model).bind_tools(\n                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n                AttributeError: 'RunnableLambda' object has no attribute 'bind_tools'\n    \n                ---\n    \n                ä¸ºå•¥æŠ¥é”™\n                \"\"\").strip()\n        }]\n    })\n\n    return result","key":"kc0gaO8yJn"},{"type":"outputs","id":"t_WpcoUYLtSA3GBjPan_7","children":[],"key":"P4kEREG7Lw"}],"key":"HGNoJVaXOW"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"ğŸ‰ ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"B9KO4C0XfS"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"å¤„ç½®æ–¹å¼ä¸€","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rwTanv4CwX"}],"key":"twok20PEMy"},{"type":"text","value":"ï¼šå¦‚é‡éšç§ä¿¡æ¯ï¼Œæ‹’ç»å›å¤ã€‚","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WQtYIHzcGw"}],"key":"FcJU1NjJ0m"}],"key":"lsiboO2F51"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@before_agent(can_jump_to=[\"end\"])\ndef content_blocker(state: AgentState,  runtime: Runtime) -> dict[str, Any] | None:\n    \"\"\"Deterministic guardrail: Block requests containing banned keywords.\"\"\"\n    # Get the first user message\n    if not state[\"messages\"]:\n        return None\n\n    last_message = state[\"messages\"][-1]\n    if last_message.type != \"human\":\n        return None\n\n    content = last_message.content.lower()\n    prompt = (\n        \"ä½ æ˜¯ä¸€ä¸ªéšç§ä¿æŠ¤åŠ©æ‰‹ã€‚è¯·è¯†åˆ«ä¸‹é¢æ–‡æœ¬ä¸­æ¶‰åŠä¸ªäººå¯è¯†åˆ«ä¿¡æ¯ï¼ˆPIIï¼‰ï¼Œ\"\n        \"ä¾‹å¦‚ï¼šå§“åã€èº«ä»½è¯å·ã€æŠ¤ç…§å·ã€ç”µè¯å·ç ã€é‚®ç®±ã€ä½å€ã€é“¶è¡Œå¡å·ã€ç¤¾äº¤è´¦å·ã€è½¦ç‰Œç­‰ã€‚\"\n        \"ç‰¹åˆ«æ³¨æ„ï¼Œè‹¥ä»£ç ã€æ–‡ä»¶è·¯å¾„ä¸­åŒ…å«ç”¨æˆ·åï¼Œä¹Ÿåº”è¢«è§†ä¸ºæ•æ„Ÿä¿¡æ¯ã€‚\"\n        \"è‹¥åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œè¯·è¿”å›{\\\"is_pii\\\": True}ï¼Œå¦åˆ™è¿”å›{\\\"is_pii\\\": False}ã€‚\"\n        \"è¯·ä¸¥æ ¼ä»¥ json æ ¼å¼è¿”å›ï¼Œå¹¶ä¸”åªè¾“å‡º jsonã€‚æ–‡æœ¬å¦‚ä¸‹ï¼š\\n\\n\" + content\n    )\n\n    pii_agent = trusted_model.with_structured_output(PiiCheck)\n    result = pii_agent.invoke(prompt)\n\n    if result.is_pii is True:\n        # Block execution before any processing\n        return {\n            \"messages\": [{\n                \"role\": \"assistant\",\n                \"content\": \"I cannot process requests containing inappropriate content. Please rephrase your request.\"\n            }],\n            \"jump_to\": \"end\"\n        }\n    else:\n        print(\"No PII found\")\n\n    return None","key":"DiLtswvKX6"},{"type":"outputs","id":"PlLtqlqXvjtfw75Deb8DJ","children":[],"key":"Spm3qivOGG"}],"key":"GucuqiaqkQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"result = message_with_pii(pii_middleware=content_blocker)\n\nfor message in result[\"messages\"]:\n    message.pretty_print()","key":"eQ154ndFiX"},{"type":"outputs","id":"mUeDlfWWr_mkNyVTJw7hF","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nFile \"/home/luochang/proj/agent.py\", line 53, in my_agent\n    agent = create_react_agent(\n            ^^^^^^^^^^^^^^^^^^^\nFile \"/home/luochang/miniconda3/lib/python3.12/site-packages/typing_extensions.py\", line 2950, in wrapper\n    return arg(*args, **kwargs)\n        ^^^^^^^^^^^^^^^^^^^^\nFile \"/home/luochang/miniconda3/lib/python3.12/site-packages/langgraph/prebuilt/chat_agent_executor.py\", line 566, in create_react_agent\n    model = cast(BaseChatModel, model).bind_tools(\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAttributeError: 'RunnableLambda' object has no attribute 'bind_tools'\n\n---\n\nä¸ºå•¥æŠ¥é”™\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nI cannot process requests containing inappropriate content. Please rephrase your request.\n"},"children":[],"key":"cFl0aRp2MV"}],"key":"xx9MjGPPVO"}],"key":"TH7v5e65tC"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"ğŸ€ ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"n8izgZHm3x"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"å¤„ç½®æ–¹å¼äºŒ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bfRMuGHChM"}],"key":"a9PoYLE2lF"},{"type":"text","value":"ï¼šå¦‚é‡æ•æ„Ÿä¿¡æ¯ï¼Œä½¿ç”¨ä¸€ä¸²  ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UrrfkpgVPk"},{"type":"inlineCode","value":"*****","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Q0OtPRNlUm"},{"type":"text","value":" å·å±è”½éšç§ä¿¡æ¯ã€‚","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jXnDUsCGQu"}],"key":"lB5H0hdO7L"}],"key":"olQ33aYHbJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@before_agent(can_jump_to=[\"end\"])\ndef content_filter(state: AgentState,  runtime: Runtime) -> dict[str, Any] | None:\n    \"\"\"Deterministic guardrail: Block requests containing banned keywords.\"\"\"\n    # Get the first user message\n    if not state[\"messages\"]:\n        return None\n\n    last_message = state[\"messages\"][-1]\n    if last_message.type != \"human\":\n        return None\n\n    content = last_message.content.lower()\n    prompt = (\n        \"ä½ æ˜¯ä¸€ä¸ªéšç§ä¿æŠ¤åŠ©æ‰‹ã€‚è¯·è¯†åˆ«ä¸‹é¢æ–‡æœ¬ä¸­æ¶‰åŠä¸ªäººå¯è¯†åˆ«ä¿¡æ¯ï¼ˆPIIï¼‰ï¼Œ\"\n        \"ä¾‹å¦‚ï¼šå§“åã€èº«ä»½è¯å·ã€æŠ¤ç…§å·ã€ç”µè¯å·ç ã€é‚®ç®±ã€ä½å€ã€é“¶è¡Œå¡å·ã€ç¤¾äº¤è´¦å·ã€è½¦ç‰Œç­‰ã€‚\"\n        \"ç‰¹åˆ«æ³¨æ„ï¼Œè‹¥ä»£ç ã€æ–‡ä»¶è·¯å¾„ä¸­åŒ…å«ç”¨æˆ·åï¼Œä¹Ÿåº”è¢«è§†ä¸ºæ•æ„Ÿä¿¡æ¯ã€‚\"\n        \"è‹¥åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œè¯·è¿”å›{\\\"is_pii\\\": True}ï¼Œå¦åˆ™è¿”å›{\\\"is_pii\\\": False}ã€‚\"\n        \"è¯·ä¸¥æ ¼ä»¥ json æ ¼å¼è¿”å›ï¼Œå¹¶ä¸”åªè¾“å‡º jsonã€‚æ–‡æœ¬å¦‚ä¸‹ï¼š\\n\\n\" + content\n    )\n\n    pii_agent = trusted_model.with_structured_output(PiiCheck)\n    result = pii_agent.invoke(prompt)\n\n    if result.is_pii is True:\n        mask_prompt = (\n            \"ä½ æ˜¯ä¸€ä¸ªéšç§ä¿æŠ¤åŠ©æ‰‹ã€‚è¯·å°†ä¸‹é¢æ–‡æœ¬ä¸­çš„æ‰€æœ‰ä¸ªäººå¯è¯†åˆ«ä¿¡æ¯ï¼ˆPIIï¼‰ç”¨æ˜Ÿå·ï¼ˆ*ï¼‰æ›¿æ¢ã€‚\"\n            \"ä»…æ›¿æ¢æ•æ„Ÿç‰‡æ®µï¼Œå…¶ä»–æ–‡æœ¬ä¿æŒä¸å˜ã€‚\"\n            \"åªè¾“å‡ºå¤„ç†åçš„æ–‡æœ¬ï¼Œä¸è¦ä»»ä½•è§£é‡Šæˆ–é¢å¤–å†…å®¹ã€‚æ–‡æœ¬å¦‚ä¸‹ï¼š\\n\\n\" + last_message.content\n        )\n        masked_message = basic_model.invoke(mask_prompt)\n        return {\n            \"messages\": [{\n                \"role\": \"assistant\",\n                \"content\": masked_message.content\n            }]\n        }\n    else:\n        print(\"No PII found\")\n\n    return None","key":"JZzRKlNngY"},{"type":"outputs","id":"iw00DJlhA1aysAH9eBguC","children":[],"key":"woakvO90Ce"}],"key":"BNYg0QFato"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"result = message_with_pii(pii_middleware=content_filter)\n\nfor message in result[\"messages\"]:\n    message.pretty_print()","key":"GHXs66OAhU"},{"type":"outputs","id":"vGNe29bTis7UUW9s53_Ty","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nFile \"/home/luochang/proj/agent.py\", line 53, in my_agent\n    agent = create_react_agent(\n            ^^^^^^^^^^^^^^^^^^^\nFile \"/home/luochang/miniconda3/lib/python3.12/site-packages/typing_extensions.py\", line 2950, in wrapper\n    return arg(*args, **kwargs)\n        ^^^^^^^^^^^^^^^^^^^^\nFile \"/home/luochang/miniconda3/lib/python3.12/site-packages/langgraph/prebuilt/chat_agent_executor.py\", line 566, in create_react_agent\n    model = cast(BaseChatModel, model).bind_tools(\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAttributeError: 'RunnableLambda' object has no attribute 'bind_tools'\n\n---\n\nä¸ºå•¥æŠ¥é”™\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nFile \"/home/********/proj/agent.py\", line 53, in my_agent\n    agent = create_react_agent(\n            ^^^^^^^^^^^^^^^^^^^\nFile \"/home/********/miniconda3/lib/python3.12/site-packages/typing_extensions.py\", line 2950, in wrapper\n    return arg(*args, **kwargs)\n        ^^^^^^^^^^^^^^^^^^^^\nFile \"/home/********/miniconda3/lib/python3.12/site-packages/langgraph/prebuilt/chat_agent_executor.py\", line 566, in create_react_agent\n    model = cast(BaseChatModel, model).bind_tools(\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAttributeError: 'RunnableLambda' object has no attribute 'bind_tools'\n\n---\n\nä¸ºå•¥æŠ¥é”™\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nè¿™ä¸ªé”™è¯¯çš„åŸå› æ˜¯ï¼š**ä½ ä¼ ç»™ `create_react_agent` çš„ model å‚æ•°æ˜¯ä¸€ä¸ª `RunnableLambda` å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªèŠå¤©æ¨¡å‹å¯¹è±¡**ã€‚\n\n## é”™è¯¯åˆ†æ\n\n`create_react_agent` å‡½æ•°æœŸæœ›æ¥æ”¶ä¸€ä¸ªå®ç°äº† `bind_tools` æ–¹æ³•çš„èŠå¤©æ¨¡å‹ï¼ˆå¦‚ `ChatOpenAI`ã€`ChatAnthropic` ç­‰ï¼‰ï¼Œä½†ä½ ä¼ å…¥çš„æ˜¯ä¸€ä¸ª `RunnableLambda` å¯¹è±¡ï¼Œå®ƒæ²¡æœ‰ `bind_tools` æ–¹æ³•ã€‚\n\n## å¸¸è§åŸå› å’Œè§£å†³æ–¹æ¡ˆ\n\n### 1. ç›´æ¥ä¼ å…¥äº† RunnableLambda è€Œä¸æ˜¯æ¨¡å‹\n\n**é”™è¯¯å†™æ³•ï¼š**\n```python\nfrom langchain_core.runnables import RunnableLambda\n\n# é”™è¯¯ï¼šç›´æ¥ç”¨ RunnableLambda ä½œä¸ºæ¨¡å‹\nmodel = RunnableLambda(some_function)\nagent = create_react_agent(model, tools)  # è¿™é‡Œä¼šæŠ¥é”™\n```\n\n**æ­£ç¡®å†™æ³•ï¼š**\n```python\nfrom langchain_openai import ChatOpenAI\n\n# æ­£ç¡®ï¼šä½¿ç”¨çœŸæ­£çš„èŠå¤©æ¨¡å‹\nmodel = ChatOpenAI(model=\"gpt-3.5-turbo\")\nagent = create_react_agent(model, tools)\n```\n\n### 2. æ¨¡å‹è¢«åŒ…è£…æˆäº† RunnableLambda\n\n**å¯èƒ½çš„é”™è¯¯æƒ…å†µï¼š**\n```python\n# å¦‚æœä½ åœ¨æŸä¸ªåœ°æ–¹è¿™æ ·åšäº†\nmodel = RunnableLambda(lambda x: some_chat_model.invoke(x))\n```\n\n**è§£å†³æ–¹æ³•ï¼šç›´æ¥ä½¿ç”¨åŸå§‹æ¨¡å‹**\n\n### 3. æ£€æŸ¥ä½ çš„ä»£ç \n\nåœ¨è°ƒç”¨ `create_react_agent` ä¹‹å‰ï¼Œæ£€æŸ¥ä½ çš„ model å˜é‡ï¼š\n\n```python\nprint(type(model))  # åº”è¯¥æ˜¾ç¤ºç±»ä¼¼ <class 'langchain_openai.chat_models.ChatOpenAI'>\n\n# ç¡®ä¿ä½ çš„å¯¼å…¥æ­£ç¡®\nfrom langchain_openai import ChatOpenAI\n# æˆ–è€…\nfrom langchain_anthropic import ChatAnthropic\n# æˆ–è€…å…¶ä»–æ”¯æŒçš„èŠå¤©æ¨¡å‹\n\nmodel = ChatOpenAI(model=\"gpt-3.5-turbo\")  # æˆ–å…¶ä»–æ¨¡å‹\nagent = create_react_agent(model, tools)\n```\n\n## å®Œæ•´çš„æ­£ç¡®ç¤ºä¾‹\n\n```python\nfrom langchain_openai import ChatOpenAI\nfrom langgraph.prebuilt import create_react_agent\n\n# ä½¿ç”¨æ­£ç¡®çš„èŠå¤©æ¨¡å‹\nmodel = ChatOpenAI(model=\"gpt-3.5-turbo\")\n\n# åˆ›å»ºå·¥å…·åˆ—è¡¨\ntools = [tool1, tool2]  # ä½ çš„å·¥å…·\n\n# åˆ›å»º agent\nagent = create_react_agent(model, tools)\n```\n\næ£€æŸ¥ä¸€ä¸‹ä½ çš„ç¬¬53è¡Œé™„è¿‘çš„ä»£ç ï¼Œç¡®ä¿ä¼ ç»™ `create_react_agent` çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªçœŸæ­£çš„èŠå¤©æ¨¡å‹å¯¹è±¡ã€‚\n"},"children":[],"key":"ekTFZRyzp7"}],"key":"VtxmkyiMlA"}],"key":"Y5o843Ijj7"}],"key":"jDxNN0UoFI"},"references":{"cite":{"order":[],"data":{}}}}