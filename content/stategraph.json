{"version":3,"kind":"Notebook","sha256":"a1208a0371d33e00c17850f535bba66167468a35cabceb456e364d513fad4bac","slug":"stategraph","location":"/2.stategraph.ipynb","dependencies":[],"frontmatter":{"title":"状态图","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3","language":"python"},"authors":[{"nameParsed":{"literal":"Larry Li","given":"Larry","family":"Li"},"name":"Larry Li","id":"contributors-Users\\Lenovo\\Desktop\\product\\dive-into-langgraph-plus\\myst-generated-uid-0"}],"github":"https://github.com/LarryLi93/dive-into-langgraph-plus","exports":[{"format":"ipynb","filename":"2.stategraph.ipynb","url":"/2.stategraph-5f3a459114fea5579e5ff3cfdd3c295a.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"在上一节中，我们演示了如何使用 LangGraph 创建 ReAct Agent。但是，把任务交给 Agent 等于把控制权也交了出去。如果你不希望 Agent 拥有如此高的控制权，而是希望流程完全受你控制，那么你可以使用 ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QVrlD4r0Y2"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"状态图","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"S62aeMsReg"}],"key":"SOG6jjuSTD"},{"type":"text","value":"（StateGraph）来创建工作流。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"u9LyX5do8I"}],"key":"vplHejmbI5"}],"key":"XuYnXDbW1g"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nfrom dotenv import load_dotenv\nfrom langchain_openai import ChatOpenAI\nfrom langgraph.graph import StateGraph, MessagesState, START, END\nfrom langchain_core.messages import SystemMessage, HumanMessage\nfrom langchain_core.tools import tool\n\n# 关键节点：ToolNode\nfrom langgraph.prebuilt import ToolNode\nfrom langchain_core.runnables import RunnableConfig\n\n# 加载模型配置\n_ = load_dotenv()","key":"YA2I7zvVwP"},{"type":"outputs","id":"_ccqK2C5yKtqj0hlpTcDC","children":[],"key":"JHkIip3D94"}],"key":"QjLM49jjVy"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"本节实现了一个简单的工作流。该工作流接入一个可查询天气的工具。区别于 ReAct Agent 可以自主实现工具调用，这里我们通过“条件边”，手动编写工具的触发逻辑。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hFI89awgM1"}],"key":"ABN6xTbyN5"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"为了实现这一目标，我们需要先创建三样东西：","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BCI9S01iMz"}],"key":"olfQCNdpKN"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"助手节点","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"mPJxkeNkNj"}],"key":"GK55llBPci"},{"type":"text","value":"：装载了 LLM，用于判断是否需要调用工具","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"fxngSoEiSW"}],"key":"LvPqautEqe"}],"key":"rl0VAsZhSE"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"工具节点","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"lHJRyZdrW4"}],"key":"L2xQZlCHQc"},{"type":"text","value":"：一个可获取城市天气的工具。这里被我们简化，对任何城市均输出晴天","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"NQT1IDuneM"}],"key":"Ew0RE3JP9a"}],"key":"KmW0OXuKqk"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"条件边","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"k4kqTR2TZD"}],"key":"QRBw7I5mBw"},{"type":"text","value":"：连接助手节点与工具节点。根据助手节点的输出，决定是否调用工具（即对应下图中的2条虚线）","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"gei38cPxtL"}],"key":"SZqQKh1ANo"}],"key":"yEwjzW1Rtd"}],"key":"ZpwIhDZtGk"}],"key":"sJo1FYePIJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 加载模型\nllm = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n    temperature=0.7,\n)\n\n# 工具函数\n@tool\ndef get_weather(city: str) -> str:\n    \"\"\"Get weather for a given city.\"\"\"\n    return f\"It's always sunny in {city}!\"\n\n# 创建工具节点\ntools = [get_weather]\ntool_node = ToolNode(tools)\n\n# 创建带工具的LLM助手节点\ndef assistant(state: MessagesState, config: RunnableConfig):\n    system_prompt = 'You are a helpful assistant that can check weather.'\n    all_messages = [SystemMessage(system_prompt)] + state['messages']\n    model = llm.bind_tools(tools)\n    return {'messages': [model.invoke(all_messages)]}\n\n# 创建条件边\ndef should_continue(state: MessagesState, config: RunnableConfig):\n    messages = state['messages']\n    last_message = messages[-1]\n    # 如果最后一条消息是LL决定使用工具调用，则继续\n    if last_message.tool_calls:\n        return 'continue'\n    # 否则，结束\n    return 'end'","key":"zOJGCvYSsB"},{"type":"outputs","id":"hHtbAE0Rcrfln3V_dZdPc","children":[],"key":"IBfjWLlvKR"}],"key":"Box8LqRML3"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"有了这三样东西，只是有了构建状态图（StateGraph）的基础原料。要让状态图运行起来，还需要 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fGJfbAyapJ"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"定义节点和边之间的关系","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nNxxSYiqzy"}],"key":"QJRRLXJZR2"},{"type":"text","value":"。在下面的代码中，我们先将节点添加到 StateGraph 实例中，然后以正确的顺序桥接它们。这样我们就获得了一个可以运行的工作流。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WVfgHRCnpp"}],"key":"gxAIk6HgNB"}],"key":"Yh9crk6UkJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 创建图\nbuilder = StateGraph(MessagesState)\n\n# 添加节点\nbuilder.add_node('assistant', assistant)\nbuilder.add_node('tool', tool_node)\n\n# 添加边（从START到assistant）\nbuilder.add_edge(START, 'assistant')\n\n# 添加条件边（根据assistant的输出，决定是否调用工具）\nbuilder.add_conditional_edges(\n    # 条件边连接的节点  \n    'assistant', \n    # 条件边判断逻辑\n    should_continue,\n    # 条件边判断逻辑为True时，调用tool节点\n    {\n        'continue': 'tool',\n        'end': END,\n    },\n)\n\n# 添加边：调用工具节点后回到assistant\nbuilder.add_edge('tool', 'assistant')\n\n# 编译图\nmy_graph = builder.compile(name='my-graph')\nmy_graph","key":"vS9XA4hLDd"},{"type":"outputs","id":"XVSG_D7GS3tIyLrRjIgHr","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":7,"metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"24b36b3744e64e740299ccac423f3798","path":"/24b36b3744e64e740299ccac423f3798.png"},"text/plain":{"content":"<langgraph.graph.state.CompiledStateGraph object at 0x000001FD0A9365D0>","content_type":"text/plain"}}},"children":[],"key":"LRDMEsGoL6"}],"key":"BtJSiL0F46"}],"key":"tKPXgVkwRl"},{"type":"block","kind":"notebook-content","children":[{"type":"admonition","position":{"start":{"line":1,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"uLa8KXPsHZ"}],"key":"vthWzYUsDH"},{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[],"key":"TEXt7XVIBs"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"有向图分为：","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"thxS4kz7cw"}],"key":"YRvvdWHxkF"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"有向无环图（DAG）","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"UzPYSb4vEY"}],"key":"xzc04gaPEN"}],"key":"xDlOytmlN9"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"有向循环图（DCG）","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"IDH0cyjQKU"}],"key":"DIlRZEYpcw"}],"key":"hx4iSTkIbJ"}],"key":"eE1vUr1Jnc"}],"kind":"note","class":"simple","key":"W7xOCSgzEG"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"从可视化结果来看，助手节点 ","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"nbZ6qXJbsY"},{"type":"inlineCode","value":"assistant","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"mii5skZMkI"},{"type":"text","value":" 与工具节点 ","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"muhRNQGDh1"},{"type":"inlineCode","value":"tool","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"yeYTgOiGvs"},{"type":"text","value":" 之间存在循环调用。因此，我们创建的是 ","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"s4UjBmslnn"},{"type":"strong","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"有向循环图","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"Rra2pHx0Z2"}],"key":"Yx6eUCiSgM"},{"type":"text","value":"。下面来看一下，当询问上海天气时，工作流的运行过程。","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"Ww306uW0lB"}],"key":"GMYOWP5PKg"}],"key":"BFGOmpVU7q"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 调用图\nresponse = my_graph.invoke({'messages': [HumanMessage(content='上海天气怎么样？')]})\nfor message in response['messages']:\n    message.pretty_print()","key":"ve9n0wUDVJ"},{"type":"outputs","id":"yyn7QGviKFQ7q5yoWg1xA","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\n上海天气怎么样？\n==================================\u001b[1m Ai Message \u001b[0m==================================\nTool Calls:\n  get_weather (call_35b1a72ef3cb42ce9275c867)\n Call ID: call_35b1a72ef3cb42ce9275c867\n  Args:\n    city: 上海\n=================================\u001b[1m Tool Message \u001b[0m=================================\nName: get_weather\n\nIt's always sunny in 上海!\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\n上海的天气很好，总是阳光明媚！\n"},"children":[],"key":"nR0ycBC49z"}],"key":"wJWIWFISQi"}],"key":"IuROlbekEb"}],"key":"GysIb9THEe"},"references":{"cite":{"order":[],"data":{}}}}