{"version":3,"kind":"Notebook","sha256":"f33a05516379edbd84d809407197f72ed3585171300e7cf51882cd07b50c837c","slug":"mcp-server","location":"/7.mcp_server.ipynb","dependencies":[],"frontmatter":{"title":"MCP服务器","content_includes_title":false,"kernelspec":{"name":"py313","display_name":"Python (py3.13)","language":"python"},"authors":[{"nameParsed":{"literal":"Larry Li","given":"Larry","family":"Li"},"name":"Larry Li","id":"contributors-Users\\Lenovo\\Desktop\\product\\dive-into-langgraph-plus\\myst-generated-uid-0"}],"github":"https://github.com/LarryLi93/dive-into-langgraph-plus","exports":[{"format":"ipynb","filename":"7.mcp_server.ipynb","url":"/7.mcp_server-c1e4c0048d9a7bdedacf6351614bd3e9.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"本节，我们将在 LangGraph 中接入 MCP Server。在接入 MCP Server 之前，必须得有 MCP Server。也就是说，我们得开发一个 MCP Server。这可是我的老本行。在","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"pCT2PZvERN"},{"type":"link","url":"https://www.luochang.ink/posts/card_magic_mcp/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"《新瓶装旧酒：纸牌魔术 MCP》","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vY7Rwel76p"}],"urlSource":"https://www.luochang.ink/posts/card_magic_mcp/","key":"VNprnyHi9I"},{"type":"text","value":"一文中，我已经总结出一套高效的开发方法了。创建 MCP Server 的完整代码，我放在仓库的 ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"EImG1ciaul"},{"type":"link","url":"https://github.com/luochang212/dive-into-langgraph/tree/main/mcp_server","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"mcp_server","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"atYODe5oCM"}],"urlSource":"https://github.com/luochang212/dive-into-langgraph/tree/main/mcp_server","error":true,"key":"Ph1Q6Q23Ly"},{"type":"text","value":" 路径下，如有兴趣可往一观。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mdLzbhbqjv"}],"key":"S0WS3fc03i"},{"type":"heading","depth":2,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"一、开发 MCP 服务","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Vr0IJ8g7a6"}],"identifier":"id-mcp","label":"一、开发 MCP 服务","html_id":"id-mcp","implicit":true,"key":"ImlPPcVMye"},{"type":"heading","depth":3,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"1）天气 MCP","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"auw9Ly2Bl2"}],"identifier":"id-1-mcp","label":"1）天气 MCP","html_id":"id-1-mcp","implicit":true,"key":"qqnoUBDqw2"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"以 ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"tT20k0oryY"},{"type":"inlineCode","value":"get_weather_mcp","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"wqeSCN4pHv"},{"type":"text","value":" 为例，我们要把这个 MCP 写成一个 Python 包。当然仅供本地使用，如果你想传到 PyPI 上当然可以，但那就是另外的流程了，敬请参考我的博客 ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"l9xqWwT4Qk"},{"type":"link","url":"https://luochang212.github.io/posts/pypi_packaging/","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"《PyPI 打包小记》","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"n5U7LInQkw"}],"urlSource":"https://luochang212.github.io/posts/pypi_packaging/","key":"TIgXtsPzRP"},{"type":"text","value":"。","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"warN2rkdrk"}],"key":"iDyuEeEgnE"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"为了让它被识别为 Python 包，我们要在项目下，新建一个 ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"f933R4N5gU"},{"type":"inlineCode","value":"__init__.py","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"Jyb1zqD8qc"},{"type":"text","value":" 文件。然后把主逻辑写在 ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"DB1hpTYpNG"},{"type":"inlineCode","value":"server.py","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"oc09v0d2P8"},{"type":"text","value":" 中，接着在 ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"G3jompnJ5k"},{"type":"inlineCode","value":"__main__.py","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"TzwVBdsRJT"},{"type":"text","value":" 中使用 ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"gi0vyUrZJP"},{"type":"inlineCode","value":"from . import server","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"CnIUxDmWkr"},{"type":"text","value":" 引入它。最后用 streamable-http 的方式部署它：","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"LgaSUTO8vr"}],"key":"K9l1AoYYv4"},{"type":"code","lang":"python","value":"def http():\n    \"\"\"streamable-http entry point for the package.\"\"\"\n    asyncio.run(server.mcp.run(transport=\"http\",\n                               host=host,\n                               port=port,\n                               path=\"/mcp\"))","position":{"start":{"line":13,"column":1},"end":{"line":20,"column":1}},"key":"WMCjqiZEua"},{"type":"paragraph","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"text","value":"写到这里就齐活了。这里使用 ","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"OVtaObVP03"},{"type":"inlineCode","value":"__main__.py","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"ERMyJ3A7Rp"},{"type":"text","value":" 是有小巧思的，这样我们可以将这个包作为模块直接在命令行使用。什么意思呢？就是我们用 ","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"EFYG0LDaXL"},{"type":"inlineCode","value":"python -m [包名]","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"jTdlTNktNy"},{"type":"text","value":" 就等于直接运行了 ","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"AxftsOTUHl"},{"type":"inlineCode","value":"__main__.py","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"nSvPE3t7Nd"},{"type":"text","value":" 这个特殊文件。由于我们先前在该特殊文件中启动了 ","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"cYEmrZxcAc"},{"type":"inlineCode","value":"http()","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"VUy9XnM2XR"},{"type":"text","value":" 函数，这样就能快捷方便地把 MCP Server 启动起来了！对于我们的 ","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"YToBKVbeOi"},{"type":"inlineCode","value":"get_weather_mcp","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"a1mcG8YbS0"},{"type":"text","value":"，启动命令如下：","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"uatPkQu5ih"}],"key":"rl3BIEy6uE"},{"type":"code","lang":"bash","value":"python -m get_weather_mcp","position":{"start":{"line":24,"column":1},"end":{"line":26,"column":1}},"key":"qBwRjeX18N"},{"type":"heading","depth":3,"position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"text","value":"2）算数 MCP","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"EkH3R8NhtV"}],"identifier":"id-2-mcp","label":"2）算数 MCP","html_id":"id-2-mcp","implicit":true,"key":"Gx2Otfck6h"},{"type":"paragraph","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"children":[{"type":"text","value":"这还需要赘述吗？开发流程照抄上面的步骤。","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"key":"rP8nG70pmQ"}],"key":"wK5LvJ2Sfg"},{"type":"paragraph","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"children":[{"type":"text","value":"真的是超级模版化。","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"cXobyR7X0Z"},{"type":"inlineCode","value":"__init__.py","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"pWerbXivEC"},{"type":"text","value":" 和 ","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"GhlownkADW"},{"type":"inlineCode","value":"__main__.py","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"NPsiAbjOVr"},{"type":"text","value":" 几乎完全相同。","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"Kw7nr12jLe"}],"key":"Xf5YjDsAPC"},{"type":"paragraph","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"text","value":"唯一需要改动的是 ","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"p0zZZLxPId"},{"type":"inlineCode","value":"__main__.py","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"yQtvsZTLIj"},{"type":"text","value":"。需要把端口 ","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"SKyhZlcxxB"},{"type":"inlineCode","value":"port","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"HZ8R8IlARM"},{"type":"text","value":" 改成新号码，一般来说加 1 就行。这里我们把 8000 改成 8001，其他不变：","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"HdRlKmN32r"}],"key":"BbmQQBjFGn"},{"type":"code","lang":"python","value":"# -*- coding: utf-8 -*-\nimport asyncio\nimport os\n\nfrom . import server\n\n\nhost = os.getenv('HOST', '127.0.0.1')\nport = int(os.getenv('PORT', 8001))\n\n\ndef stdio():\n    \"\"\"Stdio entry point for the package.\"\"\"\n    asyncio.run(server.mcp.run(transport=\"stdio\"))\n\n\ndef http():\n    \"\"\"streamable-http entry point for the package.\"\"\"\n    asyncio.run(server.mcp.run(transport=\"http\",\n                               host=host,\n                               port=port,\n                               path=\"/mcp\"))\n\n\nif __name__ == \"__main__\":\n    http()","position":{"start":{"line":36,"column":1},"end":{"line":63,"column":1}},"key":"R7KAPMAFVs"},{"type":"heading","depth":3,"position":{"start":{"line":65,"column":1},"end":{"line":65,"column":1}},"children":[{"type":"text","value":"二、使用 ","position":{"start":{"line":65,"column":1},"end":{"line":65,"column":1}},"key":"itTZicN9Y0"},{"type":"inlineCode","value":"supervisord","position":{"start":{"line":65,"column":1},"end":{"line":65,"column":1}},"key":"VGxnoSRyCh"},{"type":"text","value":" 管理 MCP 服务","position":{"start":{"line":65,"column":1},"end":{"line":65,"column":1}},"key":"wAhp6KoBwo"}],"identifier":"id-supervisord-mcp","label":"二、使用 supervisord 管理 MCP 服务","html_id":"id-supervisord-mcp","implicit":true,"key":"ZOXVsWpsPn"},{"type":"paragraph","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"children":[{"type":"link","url":"https://github.com/Supervisor/supervisor","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"children":[{"type":"text","value":"supervisord","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"poNhjTZ9z1"}],"urlSource":"https://github.com/Supervisor/supervisor","error":true,"key":"ip1IsLgGW6"},{"type":"text","value":" 是一个 进程管理工具。你告诉它有哪些 MCP 要跑，它会守护你的 MCP 宝宝。当 MCP 挂掉的时候，supervisord 能够自动拉起 MCP。这些内容在我的博客 ","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"W5EwME6gjh"},{"type":"link","url":"https://luochang212.github.io/posts/process_manager/","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"children":[{"type":"text","value":"《后台管理工具介绍》","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"WMAtDdi59A"}],"urlSource":"https://luochang212.github.io/posts/process_manager/","key":"pPiFy2Z2UZ"},{"type":"text","value":" 中有做简略的介绍（但更多是关于 ","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"znbb029rMS"},{"type":"inlineCode","value":"systemd","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"y2yw81DCBL"},{"type":"text","value":" 和 ","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"TKfkR1hH0O"},{"type":"inlineCode","value":"pm2","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"FCEUVLvL1E"},{"type":"text","value":" 的）。","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"d38MMMSHp0"}],"key":"FL4CLmRFLo"},{"type":"paragraph","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"children":[{"type":"text","value":"首先，我们打开项目的 ","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"rDzq0nQaX0"},{"type":"inlineCode","value":"mcp_server","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"XLFL7iHug3"},{"type":"text","value":" 路径，在这里创建一个配置文件 ","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"nFEQ0JYeR3"},{"type":"inlineCode","value":"mcp_supervisor.conf","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"pXWuelrgOa"},{"type":"text","value":"，来给 ","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"IiMxFnueem"},{"type":"inlineCode","value":"supervisord","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"ex84b1LbtY"},{"type":"text","value":" 使用。我的配置如下：","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"yubWMxBxQX"}],"key":"JyRAh6ZhUI"},{"type":"code","lang":"","value":"[unix_http_server]\nfile=/tmp/supervisor.sock\n\n[supervisord]\nlogfile=/tmp/supervisord.log\nlogfile_maxbytes=50MB\nlogfile_backups=10\nloglevel=info\npidfile=/tmp/supervisord.pid\nnodaemon=false\nminfds=1024\nminprocs=200\n\n[rpcinterface:supervisor]\nsupervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface\n\n[supervisorctl]\nserverurl=unix:///tmp/supervisor.sock\n\n[program:math_mcp]\ncommand=python -m mcp_server.math_mcp\ndirectory=..\nautostart=true\nautorestart=true\nstartsecs=5\nstopwaitsecs=10\nstdout_logfile=/tmp/math_mcp.log\nstderr_logfile=/tmp/math_mcp_err.log\n\n[program:weather_mcp]\ncommand=python -m mcp_server.get_weather_mcp\ndirectory=..\nautostart=true\nautorestart=true\nstartsecs=5\nstopwaitsecs=10\nstdout_logfile=/tmp/weather_mcp.log\nstderr_logfile=/tmp/weather_mcp_err.log\n\n[group:mcp_servers]\nprograms=math_mcp,weather_mcp","position":{"start":{"line":71,"column":1},"end":{"line":113,"column":1}},"key":"PUcz2sJi3Z"},{"type":"paragraph","position":{"start":{"line":115,"column":1},"end":{"line":115,"column":1}},"children":[{"type":"text","value":"至此，","position":{"start":{"line":115,"column":1},"end":{"line":115,"column":1}},"key":"jRjRy8Ds3v"},{"type":"inlineCode","value":"math_mcp","position":{"start":{"line":115,"column":1},"end":{"line":115,"column":1}},"key":"apuENHClSI"},{"type":"text","value":"、","position":{"start":{"line":115,"column":1},"end":{"line":115,"column":1}},"key":"ZNKqBA8XyM"},{"type":"inlineCode","value":"weather_mcp","position":{"start":{"line":115,"column":1},"end":{"line":115,"column":1}},"key":"lukUpkdCVF"},{"type":"text","value":" 的配置就完成了。这种东西没必要自己写，我让 ","position":{"start":{"line":115,"column":1},"end":{"line":115,"column":1}},"key":"iAEW6o5LJ9"},{"type":"link","url":"https://www.trae.ai/","position":{"start":{"line":115,"column":1},"end":{"line":115,"column":1}},"children":[{"type":"text","value":"TRAE","position":{"start":{"line":115,"column":1},"end":{"line":115,"column":1}},"key":"YDqXRzTnWf"}],"urlSource":"https://www.trae.ai/","key":"EoFQwqo1H4"},{"type":"text","value":" 帮我写的。下面是关于常用命令的说明！","position":{"start":{"line":115,"column":1},"end":{"line":115,"column":1}},"key":"LJRyIWLAx2"}],"key":"ENlKYs6YLS"},{"type":"heading","depth":3,"position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"children":[{"type":"text","value":"1）安装 ","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"w7Xgk7TWFu"},{"type":"inlineCode","value":"supervisord","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"ApZOp1j6xf"}],"identifier":"id-1-supervisord","label":"1）安装 supervisord","html_id":"id-1-supervisord","implicit":true,"key":"NaeWZ33747"},{"type":"code","lang":"bash","value":"pip install supervisor","position":{"start":{"line":119,"column":1},"end":{"line":121,"column":1}},"key":"kpXrEUZVkt"},{"type":"heading","depth":3,"position":{"start":{"line":123,"column":1},"end":{"line":123,"column":1}},"children":[{"type":"text","value":"2）启动 ","position":{"start":{"line":123,"column":1},"end":{"line":123,"column":1}},"key":"gZ6MNZVady"},{"type":"inlineCode","value":"supervisord","position":{"start":{"line":123,"column":1},"end":{"line":123,"column":1}},"key":"BzXifOigXt"}],"identifier":"id-2-supervisord","label":"2）启动 supervisord","html_id":"id-2-supervisord","implicit":true,"key":"BnIIhvp8Wd"},{"type":"code","lang":"bash","value":"supervisord -c ./mcp_supervisor.conf","position":{"start":{"line":125,"column":1},"end":{"line":127,"column":1}},"key":"ow4EfTnapW"},{"type":"heading","depth":3,"position":{"start":{"line":129,"column":1},"end":{"line":129,"column":1}},"children":[{"type":"text","value":"3）关闭 ","position":{"start":{"line":129,"column":1},"end":{"line":129,"column":1}},"key":"y0spkg7HR0"},{"type":"inlineCode","value":"supervisord","position":{"start":{"line":129,"column":1},"end":{"line":129,"column":1}},"key":"N6rOm9Y5UQ"}],"identifier":"id-3-supervisord","label":"3）关闭 supervisord","html_id":"id-3-supervisord","implicit":true,"key":"MKrCfWWprf"},{"type":"code","lang":"bash","value":"pkill -f supervisord","position":{"start":{"line":131,"column":1},"end":{"line":133,"column":1}},"key":"ysNPfjb9GI"},{"type":"heading","depth":3,"position":{"start":{"line":135,"column":1},"end":{"line":135,"column":1}},"children":[{"type":"text","value":"4）检查端口状态","position":{"start":{"line":135,"column":1},"end":{"line":135,"column":1}},"key":"EL3UQplR9S"}],"identifier":"id-4","label":"4）检查端口状态","html_id":"id-4","implicit":true,"key":"dNab4LKjnb"},{"type":"code","lang":"bash","value":"lsof -i :8000\nlsof -i :8001","position":{"start":{"line":137,"column":1},"end":{"line":140,"column":1}},"key":"xRVYSfK2c3"}],"key":"zPTYw2iXHs"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"三、在 LangGraph 中使用 MCP","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"b533bpxHDU"}],"identifier":"id-langgraph-mcp","label":"三、在 LangGraph 中使用 MCP","html_id":"id-langgraph-mcp","implicit":true,"key":"tkag3HTCuh"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"在使用之前，需要安装配适该功能的 Python 包：","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"rwky6OUATB"}],"key":"PIqagfz7rt"},{"type":"code","lang":"","value":"pip install langchain-mcp-adapters","position":{"start":{"line":5,"column":1},"end":{"line":7,"column":1}},"key":"b0qt7kufVy"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"我也是服了开发团队，依我看 ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"pf27VpCqeo"},{"type":"inlineCode","value":"LangChain","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"wpls0GPsTI"},{"type":"text","value":"、","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"r6vlByMrqm"},{"type":"inlineCode","value":"LangGraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"fJc2E9PtLO"},{"type":"text","value":" 不如合成一个包。还要我们去功能在哪个包里，真费劲！而且各种功能也被拆得稀碎，看看我到目前为止都安装多少包了：","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"eCfP3xu9Aa"}],"key":"vCQ8wGyRQy"},{"type":"code","lang":"bash","value":"langchain[openai]\nlangchain-mcp-adapters\nlanggraph\nlanggraph-cli[inmem]\nlanggraph-supervisor\nlanggraph-checkpoint-sqlite","position":{"start":{"line":11,"column":1},"end":{"line":18,"column":1}},"key":"ZVp9jVi5hV"},{"type":"paragraph","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"text","value":"若非 ","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"t0NsAE8oFw"},{"type":"inlineCode","value":"LangGraph 1.0","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"jTaIQyv9yv"},{"type":"text","value":" 更新了不少好功能，我是打心眼里看不上这个开源项目。衷心祝愿后起之秀 ","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"eLcwSvXzSN"},{"type":"link","url":"https://github.com/agentscope-ai/agentscope","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"text","value":"AgentScope","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"XFmnXS9Jro"}],"urlSource":"https://github.com/agentscope-ai/agentscope","error":true,"key":"R2PdfbnAcl"},{"type":"text","value":" 吸收 ","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"Og6nNUsAGT"},{"type":"inlineCode","value":"LangGraph 1.0","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"HB8KSr07DZ"},{"type":"text","value":" 的长处并超越它。当然在此之前，我们得承认 ","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"fziagMjxo8"},{"type":"inlineCode","value":"LangGraph","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"WgvdFknvFk"},{"type":"text","value":" 的地位。它虽不完美，但依然是最强大的那个。","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"udXDzW0UZj"}],"key":"T3oeNU10us"},{"type":"heading","depth":3,"position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"text","value":"1）启动 MCP 服务","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"f3oZPDm6Qu"}],"identifier":"id-1-mcp","label":"1）启动 MCP 服务","html_id":"id-1-mcp-1","implicit":true,"key":"XV9Fm6abKl"},{"type":"paragraph","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"text","value":"我们只启动天气 MCP。算数 MCP 稍后我们将以 stdio 的方式调用，无需单独启动服务。","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"AoXvasXBUg"}],"key":"IlCb6XfXHw"},{"type":"paragraph","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"text","value":"启动 ","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"hyAxhJa4sY"},{"type":"inlineCode","value":"get_weather_mcp","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"TZWwvVDl4A"},{"type":"text","value":"：","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"nOn8lct7ww"}],"key":"cRDRIsJyac"},{"type":"code","lang":"bash","value":"python -m mcp_server.get_weather_mcp ","position":{"start":{"line":28,"column":1},"end":{"line":30,"column":1}},"key":"Ed6ZDP4TOk"},{"type":"paragraph","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"children":[{"type":"text","value":"测试 MCP Server 是否成功启动：","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"P1T7rBDl7a"}],"key":"VXw65Wvflv"}],"key":"frVK3e4d5u"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# !lsof -i :8000","key":"z2i6IrlZCc"},{"type":"outputs","id":"W9nQYXN06LhagjAbrr-Xj","children":[],"key":"bp722FYgsU"}],"key":"r63sZvy9Im"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2）接入 MCP 服务","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hSMBMgnxNe"}],"identifier":"id-2-mcp","label":"2）接入 MCP 服务","html_id":"id-2-mcp-1","implicit":true,"key":"q8j977jwt7"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"使用 ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"V0oxrl0Cmq"},{"type":"inlineCode","value":"MultiServerMCPClient","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GWA87ibFQT"},{"type":"text","value":" 接入 MCP Server.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vNyNYQCOL3"}],"key":"eVVgDBmFEn"}],"key":"S49zKtWJ5H"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\n\nfrom dotenv import load_dotenv\nfrom langchain_openai import ChatOpenAI\nfrom langchain_mcp_adapters.client import MultiServerMCPClient  \nfrom langchain.agents import create_agent\n\n# 加载模型配置\n_ = load_dotenv()\n\n# 加载模型\nllm = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n    temperature=0.7,\n)\n\nasync def mcp_agent():\n    # 我们用两种方式启动 MCP Server：stdio 和 streamable_http\n    client = MultiServerMCPClient(  \n        {\n            \"math\": {\n                \"command\": \"python\",\n                \"args\": [os.path.abspath(\"./mcp_server/math_mcp/server.py\")],\n                \"transport\": \"stdio\",\n            },\n            \"weather\": {\n                \"url\": \"http://localhost:8000/mcp\",\n                \"transport\": \"streamable_http\",\n            }\n        }\n    )\n    \n    tools = await client.get_tools()\n    agent = create_agent(\n        llm,\n        tools=tools,\n    )\n\n    return agent\n\nasync def use_mcp(messages):\n    agent = await mcp_agent()\n    response = await agent.ainvoke(messages)\n    return response","key":"ZF2NU3qt4P"},{"type":"outputs","id":"LGVD39eYgszEizk7pTFeN","children":[],"key":"Bh8rRe2tbF"}],"key":"f8I9aRLwPx"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"在 Jupyter Notebook 中，使用 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"s0oz9ADdSW"},{"type":"inlineCode","value":"response = await use_mcp(messages)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WvZX4ffpsu"},{"type":"text","value":" 命令调用函数。但是在 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"U48ftU9idw"},{"type":"inlineCode","value":".py","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Zrcjgl0D0L"},{"type":"text","value":" 文件中，这种调用方法会失败。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aBqz3F1oyU"}],"key":"N9UZmFZm2I"}],"key":"civFA50Fpd"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 调用天气 MCP\nmessages = {\"messages\": [{\"role\": \"user\", \"content\": \"福州天气怎么样？\"}]}\nresponse = await use_mcp(messages)\nresponse[\"messages\"][-1].content","key":"gbX40hiO5D"},{"type":"outputs","id":"B-Wi7x0hHwT6GqECiUztD","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":3,"metadata":{},"data":{"text/plain":{"content":"'福州的天气总是晴朗明媚！如果您计划前往福州，可以期待阳光充足的天气。不过，建议您出行前还是查看一下最新的天气预报，以确保做好相应的准备。'","content_type":"text/plain"}}},"children":[],"key":"uyHrFwSnhD"}],"key":"gZap9jdO0q"}],"key":"p9lX2xjVwE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 调用算数 MCP，由于是 stdio，启动会慢一点\nmessages = {\"messages\": [{\"role\": \"user\", \"content\": \"计算 (3 + 5) * 12\"}]}\nresponse = await use_mcp(messages)\nresponse[\"messages\"][-1].content","key":"fLwq8Tue1x"},{"type":"outputs","id":"Z6FwDfTTZ_7ZQ7Squ-fKs","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/plain":{"content":"'(3 + 5) * 12 的结果是 96。'","content_type":"text/plain"}}},"children":[],"key":"uPEohwFVxD"}],"key":"H4DeXmpXF3"}],"key":"pil6GQLsY8"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"在 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"O27ke5VQXt"},{"type":"inlineCode","value":".py","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JLY45NCnMl"},{"type":"text","value":" 文件中，应该使用 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mKqb7cygdG"},{"type":"inlineCode","value":"asyncio","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ofo4E52FuJ"},{"type":"text","value":"，改动部分如下：","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tehcp10fn5"}],"key":"K82HNVkDWg"},{"type":"code","lang":"python","value":"import asyncio\n\nasync def main():\n    # 调用天气 MCP\n    messages = {\"messages\": [{\"role\": \"user\", \"content\": \"福州天气怎么样？\"}]}\n    response = await use_mcp(messages)\n    print(response[\"messages\"][-1].content)\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n","position":{"start":{"line":3,"column":1},"end":{"line":15,"column":1}},"key":"nZZKH7SDGQ"}],"key":"ppxL4TiDBS"}],"key":"qt5FrNylPO"},"references":{"cite":{"order":[],"data":{}}}}