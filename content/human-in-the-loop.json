{"version":3,"kind":"Notebook","sha256":"fc7529b262f1faca8be78115b5796fd21a1661d5a4d48deb1e9a376a6e182b5a","slug":"human-in-the-loop","location":"/4.human_in_the_loop.ipynb","dependencies":[],"frontmatter":{"title":"人机交互","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"base","language":"python"},"authors":[{"nameParsed":{"literal":"Larry Li","given":"Larry","family":"Li"},"name":"Larry Li","id":"contributors-Users\\Lenovo\\Desktop\\product\\dive-into-langgraph-plus\\myst-generated-uid-0"}],"github":"https://github.com/LarryLi93/dive-into-langgraph-plus","exports":[{"format":"ipynb","filename":"4.human_in_the_loop.ipynb","url":"/4.human_in_the_loop-93d47d86fbaba8259e69453279f1a568.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langchain/human-in-the-loop","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"人机交互","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"c4sWO3ky20"}],"urlSource":"https://docs.langchain.com/oss/python/langchain/human-in-the-loop","key":"Ygxdl3PQsL"},{"type":"text","value":"（Human-in-the-loop, HITL）指智能体为了向人类索要执行权限或额外信息而主动中断，并在获得人类反馈后继续执行的过程。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"MHzys7pKEI"}],"key":"LaXUJWAM6z"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"LangGraph 内置人机交互中间件 ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"d9Fc54cPTo"},{"type":"inlineCode","value":"HumanInTheLoopMiddleware","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"rLqyA1OQxg"},{"type":"text","value":"。触发人机交互时，HITL 会将当前状态保存到 ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"V1mNa5JWo3"},{"type":"link","url":"https://docs.langchain.com/oss/javascript/langgraph/persistence#checkpointer-libraries","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"checkpointer","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Utl4GsJUrI"}],"urlSource":"https://docs.langchain.com/oss/javascript/langgraph/persistence#checkpointer-libraries","key":"HBVeRQCLCS"},{"type":"text","value":" 短期记忆中，并等待人类回复。待获得回复后，再将状态从检查点中恢复出来，继续执行任务。","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"LL7g5wgBxP"}],"key":"dHbJZRWPu9"},{"type":"admonition","position":{"start":{"line":7,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"Dq3OeK5klr"}],"key":"i1UJND3Rhp"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"\n本例只是演示 checkpoint 在人机交互中的作用，无所谓线程结束后记忆是否保持，因此使用内存存储 ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Du1InA8AJj"},{"type":"inlineCode","value":"InMemorySaver","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"H7W9v07H3R"},{"type":"text","value":"。在生产环境中，请使用持久化检查点，例如：","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ZX8omdRNYj"}],"key":"rraJAAKTlD"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":10,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"SqliteSaver","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"HNMa5qNi6F"}],"key":"sNLqyMbCxd"}],"key":"KBJrCTJrt2"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"PostgresSaver","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"ZxOMG1SFth"}],"key":"vKR1RbXj6J"}],"key":"zC0DIRg761"},{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"MongoDBSaver","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"Wwv9onsy72"}],"key":"gLOUdyF4K0"}],"key":"TL5y20Fda5"},{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"RedisSaver","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"vBwcUjmYfl"}],"key":"oEq1A0Oqxs"}],"key":"jCpxKueMtR"}],"key":"Wr7HaQvt1m"}],"kind":"note","class":"simple","key":"nAZbP4ImlQ"}],"key":"dRItbFq4Ql"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nimport uuid\nfrom dotenv import load_dotenv\nfrom langchain_openai import ChatOpenAI\nfrom langchain.agents import create_agent\nfrom langchain.agents.middleware import HumanInTheLoopMiddleware\nfrom langchain_core.tools import tool\nfrom langgraph.checkpoint.memory import InMemorySaver\nfrom langgraph.types import Command\n\n# 加载模型配置\n_ = load_dotenv()","key":"AdgbcpbZ6N"},{"type":"outputs","id":"g77P52duEibaSJV3Rc2VU","children":[],"key":"YdvG6U4qPY"}],"key":"GfUDptS5RL"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"在下面的代码中，我们使用 HITL 中间件，为三种工具配置了人工审批流程。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"p0eo7m04rj"}],"key":"sVSJ3WqPx6"}],"key":"z9FgwKADWA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 配置大模型服务\nllm = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n)\n\n# 工具函数\n@tool\ndef get_weather(city: str) -> str:\n    \"\"\"Get weather for a given city.\"\"\"\n    return f\"It's always sunny in {city}!\"\n\n@tool\ndef add_numbers(a: float, b: float) -> float:\n    \"\"\"Add two numbers and return the sum.\"\"\"\n    return a + b\n\n@tool\ndef calculate_bmi(weight_kg: float, height_m: float) -> float:\n    \"\"\"Calculate BMI given weight in kg and height in meters.\"\"\"\n    if height_m <= 0 or weight_kg <= 0:\n        raise ValueError(\"height_m and weight_kg must be greater than 0.\")\n    return weight_kg / (height_m ** 2)\n\n# 创建带工具调用的Agent\ntool_agent = create_agent(\n    model=llm,\n    tools=[get_weather, add_numbers, calculate_bmi],\n    middleware=[\n        HumanInTheLoopMiddleware( \n            interrupt_on={\n                # 无需触发人工审批\n                \"get_weather\": False,\n                # 需要审批，且允许approve,edit,reject三种审批类型\n                \"add_numbers\": True,\n                # 需要审批，允许approve,reject两种审批类型\n                \"calculate_bmi\": {\"allowed_decisions\": [\"approve\", \"reject\"]},\n            },\n            description_prefix=\"Tool execution pending approval\",\n        ),\n    ],\n    checkpointer=InMemorySaver(),\n    system_prompt=\"You are a helpful assistant\",\n)","key":"mI8x6kGHqf"},{"type":"outputs","id":"VdyixH0YT4-TaB-5G-GAq","children":[],"key":"FMQVXbsvuI"}],"key":"iPBCl30FCV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 运行Agent\nconfig = {'configurable': {'thread_id': str(uuid.uuid4())}}\nresult = tool_agent.invoke(\n    {\"messages\": [{\n        \"role\": \"user\",\n        \"content\": \"我身高180cm，体重180斤，我的BMI是多少\"\n        # \"content\": \"what is the weather in sf\"\n    }]},\n    config=config,\n)\n\n# result['messages'][-1].content\nresult.get('__interrupt__')","key":"IZUbxv6CYn"},{"type":"outputs","id":"GeKTJ8622QqSZ3XTU2LZf","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":3,"metadata":{},"data":{"text/plain":{"content":"[Interrupt(value={'action_requests': [{'name': 'calculate_bmi', 'args': {'height_m': 1.8, 'weight_kg': 90}, 'description': \"Tool execution pending approval\\n\\nTool: calculate_bmi\\nArgs: {'height_m': 1.8, 'weight_kg': 90}\"}], 'review_configs': [{'action_name': 'calculate_bmi', 'allowed_decisions': ['approve', 'reject']}]}, id='fee064093af8bee2b29f108c79c64d36')]","content_type":"text/plain"}}},"children":[],"key":"UEM4HRE3EJ"}],"key":"Zate1E5nrF"}],"key":"vdWDhtzdgd"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"从中断信息来看，智能体已触发 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LR9uO7kpqb"},{"type":"inlineCode","value":"calculate_bmi","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oi8h1pdYPW"},{"type":"text","value":" 工具调用，并进入等待审批状态。下面我们向智能体发送「审批通过」指令，使其恢复运行。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RI9kQvIfQX"}],"key":"bhtr87bKmf"}],"key":"veuXgj7vm9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Resume with approval decision\nresult = tool_agent.invoke(\n    Command(\n        resume={\"decisions\": [{\"type\": \"approve\"}]}  # or \"edit\", \"reject\"\n    ), \n    config=config\n)\n\nresult['messages'][-1].content","key":"AGkVriPLrt"},{"type":"outputs","id":"rtuyBebbOy41ts28hRFhV","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/plain":{"content":"'您的BMI是27.8。根据中国成人BMI标准，这属于超重范围（BMI ≥ 24为超重，≥ 28为肥胖）。建议您关注饮食健康和适量运动，如有需要可咨询医生或营养师以获得更专业的指导。'","content_type":"text/plain"}}},"children":[],"key":"AN6XaOkWiR"}],"key":"kXzuqbr17o"}],"key":"iYV7S4wLTx"},{"type":"block","kind":"notebook-content","children":[{"type":"admonition","position":{"start":{"line":1,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"n0wx313p2d"}],"key":"IChTSua4V6"},{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"\n除了 HITL 之外，LangChain 还提供了多种 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yAaQVPeCUR"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"内置中间件","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"m9m5g9HNls"}],"key":"IZ14MwRegw"},{"type":"text","value":"，完整列表可以在接口文档 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GOlYvNxFd5"},{"type":"link","url":"https://reference.langchain.com/python/langchain/middleware/#middleware-classes","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"middleware-classes","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ddAsdUBr3U"}],"urlSource":"https://reference.langchain.com/python/langchain/middleware/#middleware-classes","key":"tJVnJU8tMR"},{"type":"text","value":" 中找到。这里仅列出几个示例：","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BC1db8psqu"}],"key":"r1xkqsvU3A"},{"type":"table","position":{"start":{"line":4,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"tableRow","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"tableCell","header":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"CLASS","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"COxCfGB2E6"}],"key":"Uabat6Tq1r"},{"type":"tableCell","header":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"DESCRIPTION","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"WjsL5zMHvb"}],"key":"CRbjvEPww1"}],"key":"aNE5U9Sfxf"},{"type":"tableRow","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"SummarizationMiddleware","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"i0tePGiOJg"}],"key":"uOQiYBDfPE"},{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"在接近 token 上限时自动将对话历史进行摘要","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"xV9cM9SlcK"}],"key":"wt0ofJz3aH"}],"key":"I3KMGuiG5i"},{"type":"tableRow","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"ModelCallLimitMiddleware","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Cj1fM0MoDW"}],"key":"n4hsq99KtC"},{"type":"tableCell","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"限制模型调用次数以防止成本过高","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"bFkEAqPtfR"}],"key":"dgtWy0MbJE"}],"key":"hZzjCnM8Fo"},{"type":"tableRow","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"ToolCallLimitMiddleware","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"kw6RRDhbVy"}],"key":"OIE31rcoJQ"},{"type":"tableCell","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"通过限制调用次数来控制工具执行","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"saxihns3Jd"}],"key":"lSdIZSPNJm"}],"key":"uptiEI6Z2T"},{"type":"tableRow","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"ModelFallbackMiddleware","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"ypY0Uhz9uZ"}],"key":"ZDLdkw8lI9"},{"type":"tableCell","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"当主模型失败时自动回退到备用模型","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"iah4YJ2lrP"}],"key":"u8TiotjSQ9"}],"key":"GEFb9TTk6k"},{"type":"tableRow","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"......","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"HZbheVxUen"}],"key":"uYdv7HNYez"},{"type":"tableCell","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"......","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"edrvvoFvg1"}],"key":"qfQCW2ZDx1"}],"key":"p0cE5FjK1G"}],"key":"HCIREavE0H"}],"kind":"note","class":"simple","key":"jlalcKaOW5"},{"type":"paragraph","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"参考文档：","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"FNiYK6jQk8"}],"key":"hFp36wZ2DZ"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":14,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langchain/human-in-the-loop","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"langchain​/human​-in​-the​-loop","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"RXvlhyqBW8"}],"urlSource":"https://docs.langchain.com/oss/python/langchain/human-in-the-loop","key":"JsWyLlbqgG"}],"key":"BoDNsghS4m"}],"key":"l1mfDfe4uq"},{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langchain/short-term-memory","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"langchain​/short​-term​-memory","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"kpXWm9Fp5f"}],"urlSource":"https://docs.langchain.com/oss/python/langchain/short-term-memory","key":"n6mstnz5Gy"}],"key":"wDOjeKgdUd"}],"key":"MhSz81K8py"},{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langchain/long-term-memory","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"langchain​/long​-term​-memory","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"d8g28BQJI1"}],"urlSource":"https://docs.langchain.com/oss/python/langchain/long-term-memory","key":"PxYRjhZfcY"}],"key":"UGMXcqqjKh"}],"key":"ERHQCRELOD"},{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langgraph/persistence","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"langgraph​/persistence","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"Fpev0RzFbd"}],"urlSource":"https://docs.langchain.com/oss/python/langgraph/persistence","key":"X0bzY3wzwN"}],"key":"P2FviBt88Y"}],"key":"BXqr6dnLQL"},{"type":"listItem","spread":true,"position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langgraph/use-time-travel","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"langgraph​/use​-time​-travel","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"RZwJfJoWAC"}],"urlSource":"https://docs.langchain.com/oss/python/langgraph/use-time-travel","key":"zpfgbLwOWv"}],"key":"vru6HfaAk6"}],"key":"j7RaMWmiBd"},{"type":"listItem","spread":true,"position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langgraph/add-memory","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"langgraph​/add​-memory","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"l6bWMHpOvR"}],"urlSource":"https://docs.langchain.com/oss/python/langgraph/add-memory","key":"K8mCZwmhrf"}],"key":"XSxseMsBMO"}],"key":"RXBj2fxNth"}],"key":"HuXLXlWVfK"}],"key":"acIzffcKdD"}],"key":"Vgk4ZtO5PE"},"references":{"cite":{"order":[],"data":{}}}}