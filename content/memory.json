{"version":3,"kind":"Notebook","sha256":"b6c5b19619bb24c46ccb50b3402e57a9ca2405b7f78bb7732bed2358cfff900a","slug":"memory","location":"/5.memory.ipynb","dependencies":[],"frontmatter":{"title":"记忆","content_includes_title":false,"kernelspec":{"name":"py313","display_name":"Python (py3.13)","language":"python"},"authors":[{"nameParsed":{"literal":"Larry Li","given":"Larry","family":"Li"},"name":"Larry Li","id":"contributors-Users\\Lenovo\\Desktop\\product\\dive-into-langgraph-plus\\myst-generated-uid-0"}],"github":"https://github.com/LarryLi93/dive-into-langgraph-plus","exports":[{"format":"ipynb","filename":"5.memory.ipynb","url":"/5.memory-6981ebc9f19968969011706f24be7bc5.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langgraph/add-memory","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"记忆","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"w2HYtXJgtP"}],"urlSource":"https://docs.langchain.com/oss/python/langgraph/add-memory","key":"S6TrHPreHe"},{"type":"text","value":"（Memory）是一个可选模块。如非必要，你无需向智能体添加 Memory 模块。因为 StateGraph 本身就含有历史消息列表 ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"YQswEhf6XJ"},{"type":"inlineCode","value":"messages","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"fUwPPqB6Ng"},{"type":"text","value":"，足以满足最基础的“记忆”需求。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"UZPALjMLlD"}],"key":"cBCSIuAv5U"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"需要添加 Memory 模块的情况包括：","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"kdjNOFKbvH"}],"key":"aPF0v1vBYV"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"历史消息太多，需要用外部工具存储记忆","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"rq6DeLmDW8"}],"key":"wuWpSeoho1"}],"key":"M1UaLJffhn"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"触发人工干预（","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"LkcvAUElsh"},{"type":"link","url":"https://docs.langchain.com/oss/python/langgraph/interrupts","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"interrupt","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"lWDgLENzZo"}],"urlSource":"https://docs.langchain.com/oss/python/langgraph/interrupts","key":"N2MjfyLgz2"},{"type":"text","value":"）时，临时保存 Agent 的状态","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"fnnBzUpnRy"}],"key":"V5XjUMWJaM"}],"key":"gmlL8hnzlk"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"跨对话提取用户偏好 等等","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"FpesmI7njd"}],"key":"QmTeWPLlSW"}],"key":"unA64Lipe5"}],"key":"QzsBZo7lAh"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"LangGraph 将记忆分为：","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"CWeJIBI341"}],"key":"ck8S19aCRJ"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":13,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langchain/short-term-memory","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"短期记忆","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"E9AgRg2Uui"}],"urlSource":"https://docs.langchain.com/oss/python/langchain/short-term-memory","key":"rkbppyFVXO"},{"type":"text","value":"（MemorySaver）","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"ljGZ36K6mu"}],"key":"ifXRadZ94f"}],"key":"FyJUfivHo1"},{"type":"listItem","spread":true,"position":{"start":{"line":14,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langchain/long-term-memory","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"长期记忆","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"AY3PmmVJd4"}],"urlSource":"https://docs.langchain.com/oss/python/langchain/long-term-memory","key":"Rvd8mnc7uW"},{"type":"text","value":"（MemoryStore）","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"AF48sLFMPV"}],"key":"E98YWXHeGa"}],"key":"e4hQbCh4fE"}],"key":"oNKFB7k6ZH"},{"type":"paragraph","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"此外，还有一个 ","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"CMqGmzZGL7"},{"type":"link","url":"https://langchain-ai.github.io/langmem/","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"LangMem","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"AMzN2lVUpC"}],"urlSource":"https://langchain-ai.github.io/langmem/","key":"S4j0vNBwwU"},{"type":"text","value":" 也提供记忆存取功能。","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"qvjnmIX2Wt"}],"key":"lXzqRN1fM2"},{"type":"blockquote","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"PS: 不知道为啥开发团队把记忆模块分得这么稀碎。感觉这些模块还不成熟，后边变动会比较大。","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"u19OJsZRKt"}],"key":"ZZtrxklPJb"}],"key":"R6O4UUg5tO"}],"key":"y6pmj4qRTA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nfrom dotenv import load_dotenv\nfrom langchain_openai import ChatOpenAI\nfrom langgraph.graph import StateGraph, MessagesState, START, END\nfrom langgraph.checkpoint.memory import InMemorySaver\n\n# 加载模型配置\n_ = load_dotenv()\n\n# 加载模型\nmodel = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n    temperature=0.7,\n)\n\n# 创建助手节点\ndef assistant(state: MessagesState):\n    return {'messages': [model.invoke(state['messages'])]}","key":"c96MsQddTh"},{"type":"outputs","id":"8EtSZbzpNYWB0pYYFbm6R","children":[],"key":"xePcHVqoP2"}],"key":"BZ5dT6WxrQ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"一、短期记忆","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"f3mjJA5IE5"}],"identifier":"id","label":"一、短期记忆","html_id":"id","implicit":true,"key":"rTD4IjwzCX"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"短期记忆（工作记忆）一般用于临时存储，与当前对话内容强相关。与依赖上下文的记忆方式不同，短期记忆可以主动记住重要的内容，增加工程稳定性。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FHmECeFwT5"}],"key":"OU5GicHb5B"},{"type":"heading","depth":3,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"1）在 ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"iw1PmzdzVr"},{"type":"inlineCode","value":"StateGraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"CIGGxW3sC2"},{"type":"text","value":" 中使用短期记忆","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ybQXzkoADt"}],"identifier":"id-1-stategraph","label":"1）在 StateGraph 中使用短期记忆","html_id":"id-1-stategraph","implicit":true,"key":"HkloZghUwC"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"为了方便演示，我们使用 ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"EPdICKrHpV"},{"type":"inlineCode","value":"InMemorySaver","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"F4I7bBWt4o"},{"type":"text","value":" 存储短期记忆。这意味着短期记忆存储在内存中。如果退出当前程序，记忆将会消失。","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"FzQa8F22F8"}],"key":"pMDtgXaZdL"}],"key":"d8V1spRBVB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 创建短期记忆\ncheckpointer = InMemorySaver()\n\n# 创建图\nbuilder = StateGraph(MessagesState)\n\n# 添加节点\nbuilder.add_node('assistant', assistant)\n\n# 添加边\nbuilder.add_edge(START, 'assistant')\nbuilder.add_edge('assistant', END)\n\ngraph = builder.compile(checkpointer=checkpointer)\n\n# 告诉智能体我叫 luochang\nresult = graph.invoke(\n    {'messages': ['hi! i am luochang']},\n    {\"configurable\": {\"thread_id\": \"1\"}},\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"LwvMsWeI4d"},{"type":"outputs","id":"o_9lvk7E0227C7S1B67gM","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nhi! i am luochang\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nHi Luochang! Nice to meet you. How are you doing today? Is there anything I can help you with?\n"},"children":[],"key":"Kx3VNFJywy"}],"key":"WKTzl4k79S"}],"key":"CW6MEEjxr6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 让智能体说出我的名字\nresult = graph.invoke(\n    {\"messages\": [{\"role\": \"user\", \"content\": \"What is my name?\"}]},\n    {\"configurable\": {\"thread_id\": \"1\"}},  \n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"a5Gy2oc61X"},{"type":"outputs","id":"sM8uwM9HKKiobxI0L0rEZ","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nhi! i am luochang\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nHi Luochang! Nice to meet you. How are you doing today? Is there anything I can help you with?\n================================\u001b[1m Human Message \u001b[0m=================================\n\nWhat is my name?\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nYour name is Luochang, as you introduced yourself to me earlier!\n"},"children":[],"key":"Jm5kfzf1tF"}],"key":"bfe93WHvHR"}],"key":"vq93TUvM0J"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2）在 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IKP7RDVyBm"},{"type":"inlineCode","value":"create_agent","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vZeajbJ766"},{"type":"text","value":" 中使用短期记忆","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TefdQ38mct"}],"identifier":"id-2-create-agent","label":"2）在 create_agent 中使用短期记忆","html_id":"id-2-create-agent","implicit":true,"key":"OWaOqiVM2x"}],"key":"QmcUPtBg5L"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from langchain.agents import create_agent\n\n# 创建短期记忆\ncheckpointer = InMemorySaver()\n\nagent = create_agent(\n    model=model,\n    checkpointer=checkpointer\n)\n\n# 告诉智能体我叫 luochang\nresult = agent.invoke(\n    {'messages': ['hi! i am luochang']},\n    {\"configurable\": {\"thread_id\": \"2\"}},\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"DgBDudhpIZ"},{"type":"outputs","id":"46HfeVh9Oxjbia1_i6lrq","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nhi! i am luochang\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nHi Luochang! Nice to meet you. How are you doing today? Is there anything I can help you with?\n"},"children":[],"key":"J87vRi9bmo"}],"key":"qY8AUX3Hsn"}],"key":"BFqq7grp0s"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 让智能体说出我的名字\nresult = agent.invoke(\n    {\"messages\": [{\"role\": \"user\", \"content\": \"What is my name?\"}]},\n    {\"configurable\": {\"thread_id\": \"2\"}},  \n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"h6KO8AxhyZ"},{"type":"outputs","id":"C8jUVIUqoyXasJUNUCejj","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nhi! i am luochang\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nHi Luochang! Nice to meet you. How are you doing today? Is there anything I can help you with?\n================================\u001b[1m Human Message \u001b[0m=================================\n\nWhat is my name?\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nYour name is Luochang, as you introduced yourself to me earlier!\n"},"children":[],"key":"Z3fypljfEQ"}],"key":"K9GPH2ekZ2"}],"key":"VKYtevs1Lc"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"为了验证 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dvJUFnSPOA"},{"type":"inlineCode","value":"InMemorySaver","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pQ4rFOTUWo"},{"type":"text","value":" 是否真的有效果，可以将 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"U9KqCrDQE4"},{"type":"inlineCode","value":"checkpointer=checkpointer","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BVYXaGB5eg"},{"type":"text","value":" 注释后，再观察智能体能不能正确回复我的名字。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SbbPOpyTGa"}],"key":"KlGhZcIWHY"}],"key":"GwGg4kAHaD"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"3）使用外部数据库支持的短期记忆","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uRyn2Xsrbo"}],"identifier":"id-3","label":"3）使用外部数据库支持的短期记忆","html_id":"id-3","implicit":true,"key":"CAVcnw207f"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"如果使用 SQLite 保存当前工作状态，即使退出程序，依然能在下次进入时恢复上次退出时的状态，我们来测试这一点。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"W5LN8xvPXR"}],"key":"x7fqXaIa1j"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"在使用 SQLite 作为短期记忆的外部数据库之前，需要安装一个 Python 包以支持这项功能：","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"tiPZHW6c5T"}],"key":"UR5ZUpnWba"},{"type":"code","lang":"bash","value":"pip install langgraph-checkpoint-sqlite","position":{"start":{"line":7,"column":1},"end":{"line":9,"column":1}},"key":"lc6efOg9Fu"}],"key":"FzpKHn3CFo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 删除SQLite数据库\nif os.path.exists(\"short-memory.db\"):\n    os.remove(\"short-memory.db\")","key":"eeCXk7yWKV"},{"type":"outputs","id":"_0vg9nimnK6tVkJUKUPxR","children":[],"key":"t41Qdfvc12"}],"key":"NhoooN7Rqs"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nimport sqlite3\n\nfrom dotenv import load_dotenv\nfrom langchain_openai import ChatOpenAI\nfrom langgraph.checkpoint.sqlite import SqliteSaver\nfrom langchain.agents import create_agent\n\n# 加载模型配置\n_ = load_dotenv()\n\n# 加载模型\nmodel = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n    temperature=0.7,\n)\n\n# 创建sqlite支持的短期记忆\ncheckpointer = SqliteSaver(\n    sqlite3.connect(\"short-memory.db\", check_same_thread=False)\n)\n\n# 创建Agent\nagent = create_agent(\n    model=model,\n    checkpointer=checkpointer,\n)\n\n# 告诉智能体我叫 luochang\nresult = agent.invoke(\n    {'messages': ['hi! i am luochang']},\n    {\"configurable\": {\"thread_id\": \"3\"}},\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"Ed4hWgJoDx"},{"type":"outputs","id":"4SQMz_CzAli9TlO6Uz9hG","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nhi! i am luochang\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nHi Luochang! Nice to meet you. How are you doing today? Is there anything I can help you with?\n"},"children":[],"key":"vrinNzCbj4"}],"key":"BQzJ4vUrW9"}],"key":"Y25ZmVss01"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"重启 Jupyter Notebook 后看智能体能否从 SQLite 中读取关于我名字的记忆。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EjKCRaeE1f"}],"key":"zoEETjt574"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"在 ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"kMxNPmaSCx"},{"type":"inlineCode","value":"Kernel","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mQRv6PIscw"},{"type":"text","value":" -> ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"kPLIbdHFgG"},{"type":"inlineCode","value":"Restart Kernel...","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"PrXQvoVCoZ"},{"type":"text","value":" 中重启服务。然后运行以下代码。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ohorRVpNYr"}],"key":"Y7gDH5qbG5"}],"key":"KODQ5Wgsoi"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nimport sqlite3\n\nfrom dotenv import load_dotenv\nfrom langchain_openai import ChatOpenAI\nfrom langgraph.checkpoint.sqlite import SqliteSaver\nfrom langchain.agents import create_agent\n\n# 加载模型配置\n_ = load_dotenv()\n\n# 加载模型\nmodel = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n    temperature=0.7,\n)\n\n# 创建sqlite支持的短期记忆\ncheckpointer = SqliteSaver(\n    sqlite3.connect(\"short-memory.db\", check_same_thread=False)\n)\n\n# 创建Agent\nagent = create_agent(\n    model=model,\n    checkpointer=checkpointer,\n)\n\n# 让智能体回忆我的名字\nresult = agent.invoke(\n    {'messages': ['What is my name?']},\n    {\"configurable\": {\"thread_id\": \"3\"}},\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"QgObO7qpER"},{"type":"outputs","id":"hzbbFtNHabSInpYU8lGNL","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nhi! i am luochang\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nHi Luochang! Nice to meet you. How are you doing today? Is there anything I can help you with?\n================================\u001b[1m Human Message \u001b[0m=================================\n\nWhat is my name?\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nYour name is Luochang, as you introduced yourself to me earlier!\n"},"children":[],"key":"VgoLhMVC5H"}],"key":"v6Oxz6iaT1"}],"key":"jBslRPoUzw"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"二、长期记忆","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ixmMmYhtXo"}],"identifier":"id","label":"二、长期记忆","html_id":"id-1","implicit":true,"key":"CfvpqW4HrI"}],"key":"kGVauRyIE3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nfrom dotenv import load_dotenv\nfrom openai import OpenAI\nfrom langchain_core.runnables import RunnableConfig\nfrom langchain.agents import create_agent\nfrom langchain.tools import tool, ToolRuntime\nfrom langgraph.store.memory import InMemoryStore\nfrom dataclasses import dataclass\n\nEMBED_MODEL = \"text-embedding-v4\"\nEMBED_DIM = 1024\n\n# 加载模型配置\n_ = load_dotenv()\n\n# 用于获取text embedding的接口\nclient = OpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n)\n\n# 加载模型\nmodel = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n    temperature=0.7,\n)","key":"TQLPJfvzlk"},{"type":"outputs","id":"4GrQ-b2Aba21H1YtjDjRi","children":[],"key":"ZxCBPznnF5"}],"key":"ibrXW5eoN5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# embedding生成函数\ndef embed(texts: list[str]) -> list[list[float]]:\n    response = client.embeddings.create(\n        model=EMBED_MODEL,\n        input=texts,\n        dimensions=EMBED_DIM,\n    )\n\n    return [item.embedding for item in response.data]\n\n# 测试能否正常生成text embedding\ntexts = [\n    \"LangGraph的中间件非常强大\",\n    \"LangGraph的MCP也很好用\",\n]\nvectors = embed(texts)\n\nlen(vectors), len(vectors[0])","key":"tGD8CGjgut"},{"type":"outputs","id":"yJVUfQbMmt3XlLJp-1Kmw","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":29,"metadata":{},"data":{"text/plain":{"content":"(2, 1024)","content_type":"text/plain"}}},"children":[],"key":"ggcWxMCwPK"}],"key":"J95mYDzBUu"}],"key":"Az8XQwg7GG"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"1）直接读写长期记忆","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vjGMj9itpG"}],"identifier":"id-1","label":"1）直接读写长期记忆","html_id":"id-1-1","implicit":true,"key":"lJsxNkpya0"}],"key":"UgdsjJLv3v"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# InMemoryStore saves data to an in-memory dictionary. Use a DB-backed store in production use.\nstore = InMemoryStore(index={\"embed\": embed, \"dims\": EMBED_DIM})\n\n# 添加两条用户数据\nnamespace = (\"users\", )\nkey = \"user_1\"\nstore.put(\n    namespace,\n    key,\n    {\n        \"rules\": [\n            \"User likes short, direct language\",\n            \"User only speaks English & python\",\n        ],\n        \"rule_id\": \"3\",\n    },\n)\n\nstore.put( \n    (\"users\",),  # Namespace to group related data together (users namespace for user data)\n    \"user_2\",  # Key within the namespace (user ID as key)\n    {\n        \"name\": \"John Smith\",\n        \"language\": \"English\",\n    }  # Data to store for the given user\n)\n\n# get the \"memory\" by ID\nitem = store.get(namespace, \"a-memory\") \n\n# search for \"memories\" within this namespace, filtering on content equivalence, sorted by vector similarity\nitems = store.search( \n    namespace, filter={\"rule_id\": \"3\"}, query=\"language preferences\"\n)\n\nitems","key":"FjRnM0odsU"},{"type":"outputs","id":"-SH9Bz6MJJ3-ujK8hVd2S","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":38,"metadata":{},"data":{"text/plain":{"content":"[Item(namespace=['users'], key='user_1', value={'rules': ['User likes short, direct language', 'User only speaks English & python'], 'rule_id': '3'}, created_at='2025-11-04T10:08:24.319215+00:00', updated_at='2025-11-04T10:08:24.319226+00:00', score=0.4085710154661828)]","content_type":"text/plain"}}},"children":[],"key":"CzNU8SOjmR"}],"key":"XVoZfC9p1q"}],"key":"bvZiLRrNrW"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2）使用工具读取长期记忆","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"s04UHJmFDc"}],"identifier":"id-2","label":"2）使用工具读取长期记忆","html_id":"id-2","implicit":true,"key":"bo91qSOM2Q"}],"key":"DMWP3hrZ63"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@dataclass\nclass Context:\n    user_id: str\n\n@tool\ndef get_user_info(runtime: ToolRuntime[Context]) -> str:\n    \"\"\"Look up user info.\"\"\"\n    # Access the store - same as that provided to `create_agent`\n    store = runtime.store \n    user_id = runtime.context.user_id\n    # Retrieve data from store - returns StoreValue object with value and metadata\n    user_info = store.get((\"users\",), user_id) \n    return str(user_info.value) if user_info else \"Unknown user\"\n\nagent = create_agent(\n    model=model,\n    tools=[get_user_info],\n    # Pass store to agent - enables agent to access store when running tools\n    store=store, \n    context_schema=Context\n)\n\n# Run the agent\nresult = agent.invoke(\n    {\"messages\": [{\"role\": \"user\", \"content\": \"look up user information\"}]},\n    context=Context(user_id=\"user_2\") \n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"Ay0ZGPPMdh"},{"type":"outputs","id":"hGrTf_USD4y5CYZwsa-C4","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nlook up user information\n==================================\u001b[1m Ai Message \u001b[0m==================================\nTool Calls:\n  get_user_info (call_fb3ff8f64e7f4bd1b7e2d854)\n Call ID: call_fb3ff8f64e7f4bd1b7e2d854\n  Args:\n=================================\u001b[1m Tool Message \u001b[0m=================================\nName: get_user_info\n\n{'name': 'John Smith', 'language': 'English'}\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nThe user's name is John Smith and their language is English.\n"},"children":[],"key":"F5z6eYgQXx"}],"key":"ws1gG36zZl"}],"key":"prs6Oglmf5"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"3）使用工具写入长期记忆","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PvezMXv9bL"}],"identifier":"id-3","label":"3）使用工具写入长期记忆","html_id":"id-3-1","implicit":true,"key":"SJS3zxClDI"}],"key":"Ji6PbrtJ63"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from typing_extensions import TypedDict\n\n# InMemoryStore saves data to an in-memory dictionary. Use a DB-backed store in production.\nstore = InMemoryStore() \n\n@dataclass\nclass Context:\n    user_id: str\n\n# TypedDict defines the structure of user information for the LLM\nclass UserInfo(TypedDict):\n    name: str\n\n# Tool that allows agent to update user information (useful for chat applications)\n@tool\ndef save_user_info(user_info: UserInfo, runtime: ToolRuntime[Context]) -> str:\n    \"\"\"Save user info.\"\"\"\n    # Access the store - same as that provided to `create_agent`\n    store = runtime.store \n    user_id = runtime.context.user_id \n    # Store data in the store (namespace, key, data)\n    store.put((\"users\",), user_id, user_info) \n    return \"Successfully saved user info.\"\n\nagent = create_agent(\n    model=model,\n    tools=[save_user_info],\n    store=store,\n    context_schema=Context\n)\n\n# Run the agent\nagent.invoke(\n    {\"messages\": [{\"role\": \"user\", \"content\": \"My name is John Smith\"}]},\n    # user_id passed in context to identify whose information is being updated\n    context=Context(user_id=\"user_123\") \n)\n\n# You can access the store directly to get the value\nstore.get((\"users\",), \"user_123\").value","key":"Jpy9Kh5MPo"},{"type":"outputs","id":"1wasHzXnJh8uLrQEqV8tL","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":41,"metadata":{},"data":{"text/plain":{"content":"{'name': 'John Smith'}","content_type":"text/plain"}}},"children":[],"key":"JUsNelRHBl"}],"key":"aVtQAW6d52"}],"key":"SP5AfKJAKm"}],"key":"oEqVSNqi4R"},"references":{"cite":{"order":[],"data":{}}}}