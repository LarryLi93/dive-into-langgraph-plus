# smolagent Demo 汇总

目录：`backend/demos/smolagent/`

包含的主要 Demo：

- `human_demo.py`：人类协同决策的预订助手
- `rag_file_demo.py`：基于本地文件 + BM25 的检索 Agent
- `rag_qdrant_demo.py`：基于 Qdrant 向量库的企业知识库检索 Agent
- `silicon_demo.py`：最小可用的 SiliconFlow + CodeAgent 调用示例
- `spacy_demo.py`：使用网页访问工具的多跳浏览/信息汇总 Agent
- 数据文件：`1.md`（本地文档）、`company_qa.txt`（企业问答语料）

---

## 1. human_demo.py：人类协同的预订助手

**核心类/组件**

- `OpenAIServerModel`
  - 封装硅基流动的对话模型：
    - `model_id="Pro/zai-org/GLM-4.7"`
    - `api_base="https://api.siliconflow.cn/v1"`
    - `api_key=SILICON_API_KEY`
    - `max_tokens=200000`
- `CodeAgent`
  - 智能体，负责调用工具和模型：
    - `tools=[get_weather, book_hotel]`
    - `add_base_tools=True`（包含基础工具：算术、代码执行等）

**自定义工具**

1. `@tool def get_weather(location: str) -> str`
   - 功能：查询指定城市天气（调用 `wttr.in`）
   - 实现：
     - 用 `requests.get("https://wttr.in/{city}?format=3")`
     - 对异常和非 200 状态码做简单容错

2. `@tool def book_hotel(city, check_in_date, nights=1, budget="标准") -> str`
   - 功能：预订酒店，但会 **强制让“人类”二次确认**
   - 关键交互流程：
     - 在终端输出一份“订单核对单”（城市、日期、晚数、预算）
     - 用 `input(">>> (y/n) ...")` 阻塞等待人工反馈
       - 用户输入 `y/yes/是/ok/1`：视为确认
         - 生成订单号 `HT-xxxxx`
         - 返回“预订成功 + 订单号 + 详情”
       - 用户输入其他内容：视为驳回
         - 打印驳回意见
         - 返回一段明确包含“用户修改意见”的文本，指导 Agent 重新规划参数

**运行方式**

- 交互式循环：

  ```python
  if __name__ == "__main__":
      while True:
          user_input = input("👤 请输入指令 (q退出): ")
          agent.run(user_input)
  ```

- 典型用法：用户用自然语言说“帮我查一下上海今天天气，并预订明天晚上 2 晚标准酒店”，
  Agent 会先调用 `get_weather`，再调用 `book_hotel`，中间需要你在终端确认/修改。

---

## 2. rag_file_demo.py：本地文件 + BM25 检索 Agent

**目标**

- 从本地 Markdown 文件 `1.md` 构建一个简单的文本检索器；
- 使用 BM25 召回相关片段；
- 交给 `CodeAgent` 用来回答关于该文档的问题。

**关键组件**

- 硅基流动模型：
  - `OpenAIServerModel(model_id="Pro/zai-org/GLM-4.7", api_base=SILICON_BASE_URL, ...)`
- 文本检索：
  - `BM25Retriever`（来自 `langchain_community.retrievers`）
  - 文档类型：`langchain_core.documents.Document`

**文本切分**

- 自定义的 `simple_chunk_text(text, chunk_size=300, overlap=50)`：
  - 纯 Python，按字符长度切分，有一定重叠；
  - 代替 `RecursiveCharacterTextSplitter`，减少额外依赖。

- 工作流程：
  1. 读取 `1.md` 为一个字符串 `full_text`
  2. 调用 `simple_chunk_text` 切成多个片段
  3. 每个片段包装成 `Document(page_content=chunk)`
  4. 调用 `BM25Retriever.from_documents(documents)` 构建检索器

**检索工具**

- `@tool def search_local_file(query: str) -> str`
  - 调用 `bm25_retriever.invoke(query)` 获取 Top-K 片段（`k=2`）
  - 把结果用 `\n---\n` 连接成一个长字符串返回
  - 挂载到 `CodeAgent` 的工具列表中

**Agent 使用**

- `agent = CodeAgent(tools=[search_local_file], model=model, add_base_tools=True)`
- 默认问题示例：

  ```python
  question = "请查阅本地文件，总结一下里面的主要内容。"
  agent.run(question)
  ```

- 整体行为：模型会通过工具 `search_local_file` 去拿到和问题相关的文档片段，再进行总结回答。

---

## 3. rag_qdrant_demo.py：Qdrant 向量库知识库 Agent

**目标**

- 利用 Qdrant 作为远程向量数据库；
- 支持“**首次运行构建向量索引，以后直接使用**”的高效模式；
- 用 `CodeAgent` + 工具来做语义检索。

**核心配置**

- 硅基流动模型：
  - `OpenAIServerModel(model_id="Pro/zai-org/GLM-4.7", max_tokens=4096, ...)`
- 嵌入模型：
  - `OpenAIEmbeddings(model="Qwen/Qwen3-Embedding-8B", openai_api_base=SILICON_BASE_URL, ...)`
- Qdrant：
  - `QDRANT_HOST = "120.24.168.78"`
  - `QDRANT_PORT = 7021`
  - `COLLECTION_NAME = "demo_1227"`
  - 向量维度 `VECTOR_SIZE = 4096`

**智能初始化逻辑**

1. 创建 Qdrant 客户端：`client = QdrantClient(host, port)`
2. 检查集合是否存在：

   ```python
   if client.collection_exists(collection_name=COLLECTION_NAME):
       # 已有集合：直接用现有数据
       vector_store = QdrantVectorStore(client=client, collection_name=COLLECTION_NAME, embedding=embeddings)
   else:
       # 集合不存在：首次构建
       client.create_collection(...)
       vector_store = QdrantVectorStore(...)
       # 读取 company_qa.txt，切分，Embedding + add_documents
   ```

3. 文本来源：`company_qa.txt`
   - 使用与 `rag_file_demo` 类似的 `simple_chunk_text` 切分；
   - 每段包成 `Document` 后存入 Qdrant。

**检索工具**

- `@tool def search_vector_db(query: str) -> str`
  - 调用 `vector_store.similarity_search(query, k=3)`
  - 返回 Top-3 文档片段，格式为：

    ```text
    片段 1:
    ...

    ---
    片段 2:
    ...
    ```

**Agent 使用**

- `agent = CodeAgent(tools=[search_vector_db], model=model, add_base_tools=True)`
- 默认问题示例：

  ```python
  question = "出差补贴补贴有什么"
  agent.run(question)
  ```

- 重点特性：**第二次以后启动，不再重新读文件/重建向量，只复用已有集合，响应速度显著提升。**

---

## 4. silicon_demo.py：最小可用的 SiliconFlow + CodeAgent 示例

**目标**

- 展示如何简单地把硅基流动模型接入 `smolagents`；
- 不额外定义工具，只用 Agent 的基础能力。

**模型配置**

- `OpenAIServerModel`：
  - `model_id="deepseek-ai/DeepSeek-V3.1-Terminus"`
  - `api_base="https://api.siliconflow.cn/v1"`
  - `max_tokens=256000`

**Agent 配置**

- `agent = CodeAgent(tools=[], model=model, add_base_tools=True)`
  - 尽管工具列表为空，但 `add_base_tools=True` 仍会加载内部的一些基础工具（如代码执行、简单搜索等），方便测试。

**任务示例**

```python
task = "这周人民日报最重要热点是什么 ？"
result = agent.run(task)
```

用途：**验证模型连通性 + 基本推理/生成能力**，是最简版的调用模板。

---

## 5. spacy_demo.py：网页多跳浏览与信息汇总 Agent

> 文件名叫 `spacy_demo.py`，实际上和 spaCy 无关，更像是一个“Web 浏览 Agent”示例。

**核心组件**

- 模型：与 `silicon_demo` 相同（`deepseek-ai/DeepSeek-V3.1-Terminus`）
- 工具：
  - `VisitWebpageTool`：`smolagents` 内置网页访问工具，可抓取网页内容。
- Agent：

  ```python
  web_tool = VisitWebpageTool()
  agent = CodeAgent(
      tools=[web_tool],
      model=model,
      add_base_tools=False,
      max_steps=6
  )
  ```

  - `add_base_tools=False`：只使用网页工具，不用基础工具；
  - `max_steps=6`：最多规划 6 步工具调用，方便做“多跳”任务。

**任务设计**

- `target_url = "https://www.textileworld.com/category/textile-world/breaking-news/"`
- 任务描述：

  ```text
  1. 使用工具访问 target_url
  2. 在页面正文中找到最近10天内容的文章标题和链接
  3. 再次使用工具访问这些文章链接（进入下一层页面）
  4. 读取正文内容，并在 500-600 字内做汇总
  ```

**行为特点**

- 这是一个典型的 **多跳信息采集 + 聚合总结** 任务：
  - 第 1 跳：抓取列表页，识别文章条目；
  - 第 2 跳：逐篇访问文章详情；
  - 最终：综合多个页面内容做总结。

---

## 6. 综合对比与使用建议

- **human_demo.py**
  - 场景：预订、财务审批等需要**人工最终把关**的流程；
  - 亮点：`book_hotel` 通过 `input` 把“人类审计意见”反馈给 Agent，形成闭环。

- **rag_file_demo.py**
  - 场景：单机、本地文档知识库（如一个产品说明书、一个需求文档）；
  - 优点：无外部依赖，BM25 简单可靠，适合小规模文本。

- **rag_qdrant_demo.py**
  - 场景：企业级问答、多人共享知识库、数据量较大；
  - 亮点：用 Qdrant 做远程向量库，支持增量构建和高效复用。

- **silicon_demo.py**
  - 场景：连通性测试、快速试验一个新模型；
  - 是所有 Demo 的最简模板，可以作为其他项目的起点。

- **spacy_demo.py**
  - 场景：舆情监控、新闻聚合、垂直站点内容抓取；
  - 展示了 `VisitWebpageTool` + 多步规划的典型用法。

---

## 7. 如何在自己项目里复用这些模式

- 需要本地知识库问答：
  - 小规模：参考 `rag_file_demo.py` + BM25；
  - 中/大型：参考 `rag_qdrant_demo.py` + Qdrant。

- 需要带人工审批的自动化流程：
  - 参考 `human_demo.py` 的 `book_hotel` 写法，在工具里插入 `input` 审核步骤。

- 需要做 Web 抓取 + 总结：
  - 参考 `spacy_demo.py` 的 `VisitWebpageTool` + 多步任务描述。

- 只想快速测试模型效果：
  - 直接复制 `silicon_demo.py`，换掉 `model_id` 和 `api_key` 即可。

```markdown